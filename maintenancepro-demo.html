<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MaintenancePro - Demo</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --primary: #0369a1;
      --primary-dark: #075985;
      --primary-light: #e0f2fe;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--gray-100);
      color: var(--gray-800);
      line-height: 1.5;
    }
    
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 { font-size: 1.5rem; font-weight: 600; }
    
    .demo-badge {
      background: var(--warning);
      color: var(--gray-800);
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .nav-tabs {
      background: white;
      display: flex;
      border-bottom: 1px solid var(--gray-200);
      padding: 0 1rem;
      overflow-x: auto;
    }
    
    .nav-tab {
      padding: 1rem 1.5rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 500;
      color: var(--gray-500);
      white-space: nowrap;
    }
    
    .nav-tab:hover { color: var(--gray-700); }
    .nav-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    
    .main-content { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .stat-card {
      background: white;
      padding: 1.25rem;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .stat-value { font-size: 1.75rem; font-weight: 700; }
    .stat-value.blue { color: var(--primary); }
    .stat-value.yellow { color: var(--warning); }
    .stat-value.green { color: var(--success); }
    .stat-value.red { color: var(--danger); }
    .stat-label { font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase; margin-top: 0.25rem; }
    
    .card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .card-title { font-size: 1.125rem; font-weight: 600; }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      font-size: 0.875rem;
    }
    
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-secondary { background: var(--gray-200); color: var(--gray-700); }
    .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
    
    .filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .filter-select, .filter-input {
      padding: 0.5rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.375rem;
      font-size: 0.875rem;
    }
    
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--gray-200); }
    th { font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--gray-500); background: var(--gray-50); }
    tr:hover { background: var(--gray-50); }
    
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-badge.open { background: #dbeafe; color: #1e40af; }
    .status-badge.in-progress { background: #fef3c7; color: #92400e; }
    .status-badge.completed { background: #dcfce7; color: #166534; }
    .status-badge.closed { background: var(--gray-200); color: var(--gray-600); }
    .status-badge.on-hold { background: #fce7f3; color: #9d174d; }
    
    .priority-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.7rem;
      font-weight: 600;
    }
    
    .priority-badge.emergency { background: #fee2e2; color: #991b1b; }
    .priority-badge.high { background: #ffedd5; color: #c2410c; }
    .priority-badge.medium { background: #fef3c7; color: #92400e; }
    .priority-badge.low { background: #dcfce7; color: #166534; }
    
    .request-card {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    
    .request-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }
    
    .request-id { font-size: 0.75rem; color: var(--gray-500); }
    .request-title { font-weight: 600; margin-bottom: 0.25rem; }
    .request-meta { font-size: 0.875rem; color: var(--gray-600); }
    .request-location { display: flex; align-items: center; gap: 0.25rem; font-size: 0.875rem; color: var(--gray-500); }
    
    .request-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--gray-200);
    }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
    
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay.active { display: flex; }
    
    .modal {
      background: white;
      border-radius: 0.5rem;
      width: 100%;
      max-width: 550px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .modal-title { font-size: 1.125rem; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray-400); }
    .modal-body { padding: 1.5rem; }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--gray-200);
      background: var(--gray-50);
    }
    
    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.875rem; }
    
    .form-input {
      width: 100%;
      padding: 0.625rem 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.375rem;
      font-size: 0.875rem;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(3, 105, 161, 0.1);
    }
    
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    
    .timeline { border-left: 2px solid var(--gray-200); margin-left: 0.5rem; padding-left: 1rem; }
    
    .timeline-item { position: relative; padding-bottom: 1rem; }
    
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -1.35rem;
      top: 0.25rem;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--primary);
    }
    
    .timeline-date { font-size: 0.75rem; color: var(--gray-500); }
    .timeline-text { font-size: 0.875rem; }
    
    .empty-state { text-align: center; padding: 3rem; color: var(--gray-500); }
    
    .toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 2000; }
    
    .toast {
      background: var(--gray-800);
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 0.375rem;
      margin-top: 0.5rem;
      animation: slideIn 0.3s ease;
    }
    
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .kanban-board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      min-height: 400px;
    }
    
    .kanban-column {
      background: var(--gray-100);
      border-radius: 0.5rem;
      padding: 0.75rem;
    }
    
    .kanban-header {
      font-weight: 600;
      font-size: 0.875rem;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .kanban-count {
      background: var(--gray-300);
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
    }
    
    .kanban-card {
      background: white;
      border-radius: 0.375rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      cursor: pointer;
    }
    
    .kanban-card:hover { box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
    
    .kanban-card-title { font-weight: 500; font-size: 0.875rem; margin-bottom: 0.25rem; }
    .kanban-card-meta { font-size: 0.75rem; color: var(--gray-500); }
    
    @media (max-width: 1024px) {
      .kanban-board { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (max-width: 768px) {
      .form-row, .grid-2 { grid-template-columns: 1fr; }
      .kanban-board { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>üîß MaintenancePro</h1>
    <span class="demo-badge">Demo Mode</span>
  </header>
  
  <nav class="nav-tabs">
    <div class="nav-tab active" data-tab="dashboard">Dashboard</div>
    <div class="nav-tab" data-tab="requests">All Requests</div>
    <div class="nav-tab" data-tab="board">Work Board</div>
    <div class="nav-tab" data-tab="locations">Locations</div>
    <div class="nav-tab" data-tab="technicians">Technicians</div>
    <div class="nav-tab" data-tab="reports">Reports</div>
  </nav>
  
  <main class="main-content">
    <!-- Dashboard -->
    <div class="tab-content active" id="tab-dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value blue" id="stat-open">0</div>
          <div class="stat-label">Open Requests</div>
        </div>
        <div class="stat-card">
          <div class="stat-value yellow" id="stat-progress">0</div>
          <div class="stat-label">In Progress</div>
        </div>
        <div class="stat-card">
          <div class="stat-value green" id="stat-completed">0</div>
          <div class="stat-label">Completed (30 days)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value red" id="stat-emergency">0</div>
          <div class="stat-label">Emergency</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-avg-time">0</div>
          <div class="stat-label">Avg Resolution (days)</div>
        </div>
      </div>
      
      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">üö® Urgent Requests</h2>
            <button class="btn btn-primary btn-sm" onclick="openRequestModal()">+ New Request</button>
          </div>
          <div id="urgent-requests"></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">üìã Recent Activity</h2>
          </div>
          <div id="recent-activity"></div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìä Requests by Category</h2>
        </div>
        <div id="category-chart"></div>
      </div>
    </div>
    
    <!-- All Requests -->
    <div class="tab-content" id="tab-requests">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Maintenance Requests</h2>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-secondary" onclick="exportRequests()">Export</button>
            <button class="btn btn-primary" onclick="openRequestModal()">+ New Request</button>
          </div>
        </div>
        <div class="filters">
          <select class="filter-select" id="filter-status" onchange="renderRequests()">
            <option value="">All Statuses</option>
            <option value="open">Open</option>
            <option value="in-progress">In Progress</option>
            <option value="completed">Completed</option>
            <option value="closed">Closed</option>
            <option value="on-hold">On Hold</option>
          </select>
          <select class="filter-select" id="filter-priority" onchange="renderRequests()">
            <option value="">All Priorities</option>
            <option value="emergency">Emergency</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
          <select class="filter-select" id="filter-category" onchange="renderRequests()">
            <option value="">All Categories</option>
          </select>
          <input type="text" class="filter-input" placeholder="Search..." id="filter-search" oninput="renderRequests()">
        </div>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Location</th>
              <th>Category</th>
              <th>Priority</th>
              <th>Assigned</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="requests-table"></tbody>
        </table>
      </div>
    </div>
    
    <!-- Work Board -->
    <div class="tab-content" id="tab-board">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Work Board</h2>
          <button class="btn btn-primary" onclick="openRequestModal()">+ New Request</button>
        </div>
        <div class="kanban-board" id="kanban-board"></div>
      </div>
    </div>
    
    <!-- Locations -->
    <div class="tab-content" id="tab-locations">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Locations / Units</h2>
          <button class="btn btn-primary" onclick="openLocationModal()">+ Add Location</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Location</th>
              <th>Type</th>
              <th>Contact</th>
              <th>Open Requests</th>
              <th>Total Requests</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="locations-table"></tbody>
        </table>
      </div>
    </div>
    
    <!-- Technicians -->
    <div class="tab-content" id="tab-technicians">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Technicians / Staff</h2>
          <button class="btn btn-primary" onclick="openTechModal()">+ Add Technician</button>
        </div>
        <div class="grid-3" id="technicians-grid"></div>
      </div>
    </div>
    
    <!-- Reports -->
    <div class="tab-content" id="tab-reports">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìä Reports</h2>
        </div>
        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
          <button class="btn btn-primary" onclick="exportRequests()">üìã All Requests</button>
          <button class="btn btn-secondary" onclick="exportOpenRequests()">üîì Open Requests</button>
          <button class="btn btn-secondary" onclick="exportByTech()">üë∑ By Technician</button>
          <button class="btn btn-secondary" onclick="exportByLocation()">üìç By Location</button>
        </div>
        
        <h3 style="margin-bottom: 1rem;">Requests by Status</h3>
        <div id="status-chart" style="margin-bottom: 2rem;"></div>
        
        <h3 style="margin-bottom: 1rem;">Technician Workload</h3>
        <div id="tech-workload"></div>
      </div>
    </div>
  </main>
  
  <!-- Request Modal -->
  <div class="modal-overlay" id="request-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="request-modal-title">New Request</h3>
        <button class="modal-close" onclick="closeModal('request-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="req-id">
        <div class="form-group">
          <label class="form-label">Title *</label>
          <input type="text" class="form-input" id="req-title" placeholder="Brief description of the issue">
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-input" id="req-description" rows="3" placeholder="Detailed description..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Location *</label>
            <select class="form-input" id="req-location"></select>
          </div>
          <div class="form-group">
            <label class="form-label">Category</label>
            <select class="form-input" id="req-category">
              <option value="Plumbing">Plumbing</option>
              <option value="Electrical">Electrical</option>
              <option value="HVAC">HVAC</option>
              <option value="Appliances">Appliances</option>
              <option value="Structural">Structural</option>
              <option value="Landscaping">Landscaping</option>
              <option value="Cleaning">Cleaning</option>
              <option value="Security">Security</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Priority</label>
            <select class="form-input" id="req-priority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
              <option value="emergency">Emergency</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Assign To</label>
            <select class="form-input" id="req-assigned"></select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-input" id="req-status">
              <option value="open">Open</option>
              <option value="in-progress">In Progress</option>
              <option value="on-hold">On Hold</option>
              <option value="completed">Completed</option>
              <option value="closed">Closed</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Due Date</label>
            <input type="date" class="form-input" id="req-due">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Requester Name</label>
          <input type="text" class="form-input" id="req-requester" placeholder="Name of person reporting">
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea class="form-input" id="req-notes" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="req-delete-btn" onclick="deleteRequest()" style="margin-right:auto;display:none;">Delete</button>
        <button class="btn btn-secondary" onclick="closeModal('request-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveRequest()">Save</button>
      </div>
    </div>
  </div>
  
  <!-- Location Modal -->
  <div class="modal-overlay" id="location-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="location-modal-title">Add Location</h3>
        <button class="modal-close" onclick="closeModal('location-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="loc-id">
        <div class="form-group">
          <label class="form-label">Location Name *</label>
          <input type="text" class="form-input" id="loc-name" placeholder="e.g., Unit 101, Building A">
        </div>
        <div class="form-group">
          <label class="form-label">Type</label>
          <select class="form-input" id="loc-type">
            <option value="Unit">Unit</option>
            <option value="Building">Building</option>
            <option value="Common Area">Common Area</option>
            <option value="Exterior">Exterior</option>
            <option value="Office">Office</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Contact Name</label>
          <input type="text" class="form-input" id="loc-contact">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Phone</label>
            <input type="tel" class="form-input" id="loc-phone">
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="loc-email">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea class="form-input" id="loc-notes" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="loc-delete-btn" onclick="deleteLocation()" style="margin-right:auto;display:none;">Delete</button>
        <button class="btn btn-secondary" onclick="closeModal('location-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveLocation()">Save</button>
      </div>
    </div>
  </div>
  
  <!-- Technician Modal -->
  <div class="modal-overlay" id="tech-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="tech-modal-title">Add Technician</h3>
        <button class="modal-close" onclick="closeModal('tech-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="tech-id">
        <div class="form-group">
          <label class="form-label">Name *</label>
          <input type="text" class="form-input" id="tech-name">
        </div>
        <div class="form-group">
          <label class="form-label">Specialties</label>
          <input type="text" class="form-input" id="tech-specialties" placeholder="e.g., Plumbing, HVAC">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Phone</label>
            <input type="tel" class="form-input" id="tech-phone">
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="tech-email">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-input" id="tech-status">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea class="form-input" id="tech-notes" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="tech-delete-btn" onclick="deleteTech()" style="margin-right:auto;display:none;">Delete</button>
        <button class="btn btn-secondary" onclick="closeModal('tech-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveTech()">Save</button>
      </div>
    </div>
  </div>
  
  <!-- View Request Modal -->
  <div class="modal-overlay" id="view-modal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title" id="view-modal-title">Request Details</h3>
        <button class="modal-close" onclick="closeModal('view-modal')">&times;</button>
      </div>
      <div class="modal-body" id="view-modal-body"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('view-modal')">Close</button>
        <button class="btn btn-primary" id="view-edit-btn" onclick="">Edit</button>
      </div>
    </div>
  </div>
  
  <div class="toast-container" id="toast-container"></div>

  <script>
    let requests = [], locations = [], technicians = [];
    let nextReqNum = 1001;
    
    function init() {
      loadData();
      setupTabs();
      renderAll();
    }
    
    function loadData() {
      const saved = {
        requests: localStorage.getItem('maint_requests'),
        locations: localStorage.getItem('maint_locations'),
        technicians: localStorage.getItem('maint_techs')
      };
      
      technicians = saved.technicians ? JSON.parse(saved.technicians) : [
        { id: 1, name: 'Mike Johnson', specialties: 'Plumbing, HVAC', phone: '555-0101', email: 'mike@maintenance.com', status: 'active', notes: '' },
        { id: 2, name: 'Sarah Chen', specialties: 'Electrical, Appliances', phone: '555-0102', email: 'sarah@maintenance.com', status: 'active', notes: '' },
        { id: 3, name: 'Tom Williams', specialties: 'General, Landscaping', phone: '555-0103', email: 'tom@maintenance.com', status: 'active', notes: '' },
      ];
      
      locations = saved.locations ? JSON.parse(saved.locations) : [
        { id: 1, name: 'Unit 101', type: 'Unit', contact: 'John Smith', phone: '555-1001', email: 'john@email.com', notes: '' },
        { id: 2, name: 'Unit 102', type: 'Unit', contact: 'Jane Doe', phone: '555-1002', email: 'jane@email.com', notes: '' },
        { id: 3, name: 'Unit 201', type: 'Unit', contact: 'Bob Wilson', phone: '555-1003', email: 'bob@email.com', notes: '' },
        { id: 4, name: 'Lobby', type: 'Common Area', contact: '', phone: '', email: '', notes: 'Main entrance' },
        { id: 5, name: 'Pool Area', type: 'Common Area', contact: '', phone: '', email: '', notes: 'Hours: 8am-10pm' },
        { id: 6, name: 'Parking Garage', type: 'Exterior', contact: '', phone: '', email: '', notes: 'Levels 1-3' },
      ];
      
      const today = new Date().toISOString().split('T')[0];
      const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
      const lastWeek = new Date(Date.now() - 7 * 86400000).toISOString().split('T')[0];
      
      requests = saved.requests ? JSON.parse(saved.requests) : [
        { id: 1, number: 'WO-1001', title: 'Leaking faucet in bathroom', description: 'Kitchen faucet dripping constantly. Washer may need replacement.', locationId: 1, category: 'Plumbing', priority: 'medium', assignedTo: 1, status: 'in-progress', created: lastWeek, due: today, requester: 'John Smith', notes: 'Parts ordered', history: [{date: lastWeek, action: 'Created'}, {date: yesterday, action: 'Assigned to Mike Johnson'}] },
        { id: 2, number: 'WO-1002', title: 'AC not cooling properly', description: 'Unit is running but not producing cold air. Thermostat set to 72.', locationId: 2, category: 'HVAC', priority: 'high', assignedTo: 1, status: 'open', created: yesterday, due: today, requester: 'Jane Doe', notes: '', history: [{date: yesterday, action: 'Created'}] },
        { id: 3, number: 'WO-1003', title: 'Broken light fixture', description: 'Ceiling light in hallway is flickering and making buzzing noise.', locationId: 4, category: 'Electrical', priority: 'low', assignedTo: 2, status: 'completed', created: lastWeek, due: yesterday, requester: 'Building Manager', notes: 'Replaced ballast', completedDate: yesterday, history: [{date: lastWeek, action: 'Created'}, {date: yesterday, action: 'Completed by Sarah Chen'}] },
        { id: 4, number: 'WO-1004', title: 'Pool pump making noise', description: 'Loud grinding sound coming from pool pump. May need inspection.', locationId: 5, category: 'Other', priority: 'medium', assignedTo: null, status: 'open', created: today, due: null, requester: 'Resident', notes: '', history: [{date: today, action: 'Created'}] },
        { id: 5, number: 'WO-1005', title: 'Garage door sensor broken', description: 'Sensor not detecting vehicles. Gate stays open.', locationId: 6, category: 'Security', priority: 'emergency', assignedTo: 2, status: 'in-progress', created: today, due: today, requester: 'Security', notes: 'Emergency - security risk', history: [{date: today, action: 'Created'}, {date: today, action: 'Assigned to Sarah Chen - Emergency'}] },
        { id: 6, number: 'WO-1006', title: 'Dishwasher not draining', description: 'Water pools at bottom after cycle.', locationId: 3, category: 'Appliances', priority: 'medium', assignedTo: null, status: 'open', created: today, due: null, requester: 'Bob Wilson', notes: '', history: [{date: today, action: 'Created'}] },
      ];
      
      nextReqNum = Math.max(1001, ...requests.map(r => parseInt(r.number.replace('WO-', '')) || 0)) + 1;
      saveData();
    }
    
    function saveData() {
      localStorage.setItem('maint_requests', JSON.stringify(requests));
      localStorage.setItem('maint_locations', JSON.stringify(locations));
      localStorage.setItem('maint_techs', JSON.stringify(technicians));
    }
    
    function setupTabs() {
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
        });
      });
    }
    
    function renderAll() {
      renderDashboard();
      renderRequests();
      renderBoard();
      renderLocations();
      renderTechnicians();
      renderReports();
      updateSelects();
    }
    
    function updateSelects() {
      const locOpts = '<option value="">Select Location</option>' + locations.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
      document.getElementById('req-location').innerHTML = locOpts;
      
      const techOpts = '<option value="">Unassigned</option>' + technicians.filter(t => t.status === 'active').map(t => `<option value="${t.id}">${t.name}</option>`).join('');
      document.getElementById('req-assigned').innerHTML = techOpts;
      
      const categories = [...new Set(requests.map(r => r.category).filter(Boolean))];
      document.getElementById('filter-category').innerHTML = '<option value="">All Categories</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
    }
    
    // Dashboard
    function renderDashboard() {
      const thirtyDaysAgo = new Date(Date.now() - 30 * 86400000).toISOString().split('T')[0];
      
      const open = requests.filter(r => r.status === 'open').length;
      const inProgress = requests.filter(r => r.status === 'in-progress').length;
      const completed = requests.filter(r => r.status === 'completed' && r.completedDate >= thirtyDaysAgo).length;
      const emergency = requests.filter(r => r.priority === 'emergency' && r.status !== 'completed' && r.status !== 'closed').length;
      
      const completedReqs = requests.filter(r => r.status === 'completed' && r.completedDate);
      let avgTime = 0;
      if (completedReqs.length > 0) {
        const totalDays = completedReqs.reduce((sum, r) => {
          const days = Math.ceil((new Date(r.completedDate) - new Date(r.created)) / 86400000);
          return sum + days;
        }, 0);
        avgTime = (totalDays / completedReqs.length).toFixed(1);
      }
      
      document.getElementById('stat-open').textContent = open;
      document.getElementById('stat-progress').textContent = inProgress;
      document.getElementById('stat-completed').textContent = completed;
      document.getElementById('stat-emergency').textContent = emergency;
      document.getElementById('stat-avg-time').textContent = avgTime;
      
      // Urgent requests
      const urgent = requests.filter(r => 
        (r.priority === 'emergency' || r.priority === 'high') && 
        r.status !== 'completed' && r.status !== 'closed'
      ).slice(0, 5);
      
      document.getElementById('urgent-requests').innerHTML = urgent.length ? urgent.map(r => {
        const loc = locations.find(l => l.id === r.locationId);
        const tech = technicians.find(t => t.id === r.assignedTo);
        return `<div class="request-card">
          <div class="request-header">
            <div>
              <div class="request-id">${r.number}</div>
              <div class="request-title">${r.title}</div>
            </div>
            <span class="priority-badge ${r.priority}">${r.priority}</span>
          </div>
          <div class="request-location">üìç ${loc?.name || 'Unknown'}</div>
          <div class="request-footer">
            <span class="status-badge ${r.status.replace(' ', '-')}">${r.status}</span>
            <span style="font-size: 0.75rem; color: var(--gray-500);">${tech ? tech.name : 'Unassigned'}</span>
          </div>
        </div>`;
      }).join('') : '<div class="empty-state">No urgent requests</div>';
      
      // Recent activity
      const allHistory = [];
      requests.forEach(r => {
        (r.history || []).forEach(h => {
          allHistory.push({ ...h, request: r });
        });
      });
      allHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      document.getElementById('recent-activity').innerHTML = `<div class="timeline">
        ${allHistory.slice(0, 6).map(h => `
          <div class="timeline-item">
            <div class="timeline-date">${formatDate(h.date)}</div>
            <div class="timeline-text"><strong>${h.request.number}</strong>: ${h.action}</div>
          </div>
        `).join('')}
      </div>`;
      
      // Category chart
      const catCounts = {};
      requests.forEach(r => {
        catCounts[r.category] = (catCounts[r.category] || 0) + 1;
      });
      const maxCount = Math.max(...Object.values(catCounts), 1);
      
      document.getElementById('category-chart').innerHTML = Object.entries(catCounts).map(([cat, count]) => `
        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
          <span style="width: 100px; font-size: 0.875rem;">${cat}</span>
          <div style="flex: 1; height: 20px; background: var(--gray-200); border-radius: 4px; margin: 0 1rem;">
            <div style="width: ${count / maxCount * 100}%; height: 100%; background: var(--primary); border-radius: 4px;"></div>
          </div>
          <span style="width: 30px; text-align: right; font-weight: 600;">${count}</span>
        </div>
      `).join('');
    }
    
    // Requests
    function renderRequests() {
      const statusFilter = document.getElementById('filter-status').value;
      const priorityFilter = document.getElementById('filter-priority').value;
      const categoryFilter = document.getElementById('filter-category').value;
      const search = document.getElementById('filter-search').value.toLowerCase();
      
      let filtered = [...requests];
      if (statusFilter) filtered = filtered.filter(r => r.status === statusFilter);
      if (priorityFilter) filtered = filtered.filter(r => r.priority === priorityFilter);
      if (categoryFilter) filtered = filtered.filter(r => r.category === categoryFilter);
      if (search) filtered = filtered.filter(r => 
        r.title.toLowerCase().includes(search) || 
        r.number.toLowerCase().includes(search) ||
        r.description?.toLowerCase().includes(search)
      );
      
      filtered.sort((a, b) => new Date(b.created) - new Date(a.created));
      
      document.getElementById('requests-table').innerHTML = filtered.map(r => {
        const loc = locations.find(l => l.id === r.locationId);
        const tech = technicians.find(t => t.id === r.assignedTo);
        return `<tr>
          <td><strong>${r.number}</strong></td>
          <td>${r.title}</td>
          <td>${loc?.name || '-'}</td>
          <td>${r.category}</td>
          <td><span class="priority-badge ${r.priority}">${r.priority}</span></td>
          <td>${tech?.name || 'Unassigned'}</td>
          <td><span class="status-badge ${r.status.replace(' ', '-')}">${r.status}</span></td>
          <td>${formatDate(r.created)}</td>
          <td>
            <button class="btn btn-sm btn-secondary" onclick="viewRequest(${r.id})">View</button>
            <button class="btn btn-sm btn-secondary" onclick="editRequest(${r.id})">Edit</button>
          </td>
        </tr>`;
      }).join('');
    }
    
    // Board
    function renderBoard() {
      const statuses = ['open', 'in-progress', 'on-hold', 'completed'];
      const labels = { 'open': 'Open', 'in-progress': 'In Progress', 'on-hold': 'On Hold', 'completed': 'Completed' };
      
      document.getElementById('kanban-board').innerHTML = statuses.map(status => {
        const items = requests.filter(r => r.status === status);
        return `<div class="kanban-column">
          <div class="kanban-header">
            ${labels[status]}
            <span class="kanban-count">${items.length}</span>
          </div>
          ${items.map(r => {
            const loc = locations.find(l => l.id === r.locationId);
            return `<div class="kanban-card" onclick="viewRequest(${r.id})">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                <span style="font-size: 0.7rem; color: var(--gray-500);">${r.number}</span>
                <span class="priority-badge ${r.priority}" style="font-size: 0.6rem;">${r.priority}</span>
              </div>
              <div class="kanban-card-title">${r.title}</div>
              <div class="kanban-card-meta">üìç ${loc?.name || 'Unknown'}</div>
            </div>`;
          }).join('')}
        </div>`;
      }).join('');
    }
    
    function openRequestModal(id = null) {
      if (id) {
        const r = requests.find(x => x.id === id);
        document.getElementById('request-modal-title').textContent = 'Edit Request';
        document.getElementById('req-id').value = id;
        document.getElementById('req-title').value = r.title;
        document.getElementById('req-description').value = r.description || '';
        document.getElementById('req-location').value = r.locationId;
        document.getElementById('req-category').value = r.category;
        document.getElementById('req-priority').value = r.priority;
        document.getElementById('req-assigned').value = r.assignedTo || '';
        document.getElementById('req-status').value = r.status;
        document.getElementById('req-due').value = r.due || '';
        document.getElementById('req-requester').value = r.requester || '';
        document.getElementById('req-notes').value = r.notes || '';
        document.getElementById('req-delete-btn').style.display = 'block';
      } else {
        document.getElementById('request-modal-title').textContent = 'New Request';
        document.getElementById('req-id').value = '';
        document.getElementById('req-title').value = '';
        document.getElementById('req-description').value = '';
        document.getElementById('req-location').value = '';
        document.getElementById('req-category').value = 'Plumbing';
        document.getElementById('req-priority').value = 'medium';
        document.getElementById('req-assigned').value = '';
        document.getElementById('req-status').value = 'open';
        document.getElementById('req-due').value = '';
        document.getElementById('req-requester').value = '';
        document.getElementById('req-notes').value = '';
        document.getElementById('req-delete-btn').style.display = 'none';
      }
      document.getElementById('request-modal').classList.add('active');
    }
    
    function editRequest(id) { openRequestModal(id); }
    
    function viewRequest(id) {
      const r = requests.find(x => x.id === id);
      const loc = locations.find(l => l.id === r.locationId);
      const tech = technicians.find(t => t.id === r.assignedTo);
      
      document.getElementById('view-modal-title').textContent = r.number + ' - ' + r.title;
      document.getElementById('view-edit-btn').onclick = () => { closeModal('view-modal'); editRequest(id); };
      
      document.getElementById('view-modal-body').innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
          <div><strong>Location:</strong> ${loc?.name || 'Unknown'}</div>
          <div><strong>Category:</strong> ${r.category}</div>
          <div><strong>Priority:</strong> <span class="priority-badge ${r.priority}">${r.priority}</span></div>
          <div><strong>Status:</strong> <span class="status-badge ${r.status.replace(' ', '-')}">${r.status}</span></div>
          <div><strong>Assigned:</strong> ${tech?.name || 'Unassigned'}</div>
          <div><strong>Due:</strong> ${r.due ? formatDate(r.due) : 'Not set'}</div>
          <div><strong>Requester:</strong> ${r.requester || '-'}</div>
          <div><strong>Created:</strong> ${formatDate(r.created)}</div>
        </div>
        ${r.description ? `<div style="margin-bottom: 1rem;"><strong>Description:</strong><p style="margin-top: 0.25rem;">${r.description}</p></div>` : ''}
        ${r.notes ? `<div style="margin-bottom: 1rem;"><strong>Notes:</strong><p style="margin-top: 0.25rem;">${r.notes}</p></div>` : ''}
        <div><strong>History:</strong></div>
        <div class="timeline" style="margin-top: 0.5rem;">
          ${(r.history || []).map(h => `
            <div class="timeline-item">
              <div class="timeline-date">${formatDate(h.date)}</div>
              <div class="timeline-text">${h.action}</div>
            </div>
          `).join('')}
        </div>
      `;
      
      document.getElementById('view-modal').classList.add('active');
    }
    
    function saveRequest() {
      const id = document.getElementById('req-id').value;
      const title = document.getElementById('req-title').value.trim();
      const description = document.getElementById('req-description').value.trim();
      const locationId = parseInt(document.getElementById('req-location').value);
      const category = document.getElementById('req-category').value;
      const priority = document.getElementById('req-priority').value;
      const assignedTo = document.getElementById('req-assigned').value ? parseInt(document.getElementById('req-assigned').value) : null;
      const status = document.getElementById('req-status').value;
      const due = document.getElementById('req-due').value;
      const requester = document.getElementById('req-requester').value.trim();
      const notes = document.getElementById('req-notes').value.trim();
      
      if (!title || !locationId) { showToast('Please enter title and location', 'error'); return; }
      
      const today = new Date().toISOString().split('T')[0];
      
      if (id) {
        const i = requests.findIndex(r => r.id === parseInt(id));
        const oldReq = requests[i];
        const history = [...(oldReq.history || [])];
        
        if (oldReq.status !== status) {
          history.push({ date: today, action: `Status changed to ${status}` });
        }
        if (oldReq.assignedTo !== assignedTo && assignedTo) {
          const tech = technicians.find(t => t.id === assignedTo);
          history.push({ date: today, action: `Assigned to ${tech?.name}` });
        }
        
        requests[i] = { 
          ...oldReq, 
          title, description, locationId, category, priority, assignedTo, status, due, requester, notes, 
          history,
          completedDate: status === 'completed' && oldReq.status !== 'completed' ? today : oldReq.completedDate
        };
        showToast('Request updated');
      } else {
        requests.push({ 
          id: Math.max(0, ...requests.map(r => r.id)) + 1, 
          number: 'WO-' + nextReqNum,
          title, description, locationId, category, priority, assignedTo, status, due, requester, notes,
          created: today,
          history: [{ date: today, action: 'Created' }]
        });
        nextReqNum++;
        showToast('Request created');
      }
      
      saveData();
      renderAll();
      closeModal('request-modal');
    }
    
    function deleteRequest() {
      const id = parseInt(document.getElementById('req-id').value);
      if (!confirm('Delete this request?')) return;
      requests = requests.filter(r => r.id !== id);
      saveData();
      renderAll();
      closeModal('request-modal');
      showToast('Request deleted');
    }
    
    // Locations
    function renderLocations() {
      document.getElementById('locations-table').innerHTML = locations.map(l => {
        const openReqs = requests.filter(r => r.locationId === l.id && r.status !== 'completed' && r.status !== 'closed').length;
        const totalReqs = requests.filter(r => r.locationId === l.id).length;
        return `<tr>
          <td><strong>${l.name}</strong></td>
          <td>${l.type}</td>
          <td>${l.contact || '-'}</td>
          <td>${openReqs}</td>
          <td>${totalReqs}</td>
          <td><button class="btn btn-sm btn-secondary" onclick="editLocation(${l.id})">Edit</button></td>
        </tr>`;
      }).join('');
    }
    
    function openLocationModal(id = null) {
      if (id) {
        const l = locations.find(x => x.id === id);
        document.getElementById('location-modal-title').textContent = 'Edit Location';
        document.getElementById('loc-id').value = id;
        document.getElementById('loc-name').value = l.name;
        document.getElementById('loc-type').value = l.type;
        document.getElementById('loc-contact').value = l.contact || '';
        document.getElementById('loc-phone').value = l.phone || '';
        document.getElementById('loc-email').value = l.email || '';
        document.getElementById('loc-notes').value = l.notes || '';
        document.getElementById('loc-delete-btn').style.display = 'block';
      } else {
        document.getElementById('location-modal-title').textContent = 'Add Location';
        document.getElementById('loc-id').value = '';
        document.getElementById('loc-name').value = '';
        document.getElementById('loc-type').value = 'Unit';
        document.getElementById('loc-contact').value = '';
        document.getElementById('loc-phone').value = '';
        document.getElementById('loc-email').value = '';
        document.getElementById('loc-notes').value = '';
        document.getElementById('loc-delete-btn').style.display = 'none';
      }
      document.getElementById('location-modal').classList.add('active');
    }
    
    function editLocation(id) { openLocationModal(id); }
    
    function saveLocation() {
      const id = document.getElementById('loc-id').value;
      const name = document.getElementById('loc-name').value.trim();
      const type = document.getElementById('loc-type').value;
      const contact = document.getElementById('loc-contact').value.trim();
      const phone = document.getElementById('loc-phone').value.trim();
      const email = document.getElementById('loc-email').value.trim();
      const notes = document.getElementById('loc-notes').value.trim();
      
      if (!name) { showToast('Please enter location name', 'error'); return; }
      
      if (id) {
        const i = locations.findIndex(l => l.id === parseInt(id));
        locations[i] = { ...locations[i], name, type, contact, phone, email, notes };
        showToast('Location updated');
      } else {
        locations.push({ id: Math.max(0, ...locations.map(l => l.id)) + 1, name, type, contact, phone, email, notes });
        showToast('Location added');
      }
      
      saveData();
      renderAll();
      closeModal('location-modal');
    }
    
    function deleteLocation() {
      const id = parseInt(document.getElementById('loc-id').value);
      const hasReqs = requests.some(r => r.locationId === id);
      if (hasReqs && !confirm('This location has requests. Delete anyway?')) return;
      if (!hasReqs && !confirm('Delete this location?')) return;
      locations = locations.filter(l => l.id !== id);
      saveData();
      renderAll();
      closeModal('location-modal');
      showToast('Location deleted');
    }
    
    // Technicians
    function renderTechnicians() {
      document.getElementById('technicians-grid').innerHTML = technicians.map(t => {
        const assigned = requests.filter(r => r.assignedTo === t.id && r.status !== 'completed' && r.status !== 'closed').length;
        const completed = requests.filter(r => r.assignedTo === t.id && r.status === 'completed').length;
        return `<div class="card" style="margin-bottom: 0;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
              <h3 style="font-size: 1rem; margin-bottom: 0.25rem;">${t.name}</h3>
              <div style="font-size: 0.875rem; color: var(--gray-500);">${t.specialties || 'General'}</div>
            </div>
            <span class="status-badge ${t.status === 'active' ? 'completed' : 'closed'}">${t.status}</span>
          </div>
          <div style="margin: 1rem 0; font-size: 0.875rem;">
            <div>üìß ${t.email || '-'}</div>
            <div>üìû ${t.phone || '-'}</div>
          </div>
          <div style="display: flex; gap: 1rem; font-size: 0.875rem;">
            <div><strong>${assigned}</strong> active</div>
            <div><strong>${completed}</strong> completed</div>
          </div>
          <div style="margin-top: 0.75rem;">
            <button class="btn btn-sm btn-secondary" onclick="editTech(${t.id})">Edit</button>
          </div>
        </div>`;
      }).join('');
    }
    
    function openTechModal(id = null) {
      if (id) {
        const t = technicians.find(x => x.id === id);
        document.getElementById('tech-modal-title').textContent = 'Edit Technician';
        document.getElementById('tech-id').value = id;
        document.getElementById('tech-name').value = t.name;
        document.getElementById('tech-specialties').value = t.specialties || '';
        document.getElementById('tech-phone').value = t.phone || '';
        document.getElementById('tech-email').value = t.email || '';
        document.getElementById('tech-status').value = t.status;
        document.getElementById('tech-notes').value = t.notes || '';
        document.getElementById('tech-delete-btn').style.display = 'block';
      } else {
        document.getElementById('tech-modal-title').textContent = 'Add Technician';
        document.getElementById('tech-id').value = '';
        document.getElementById('tech-name').value = '';
        document.getElementById('tech-specialties').value = '';
        document.getElementById('tech-phone').value = '';
        document.getElementById('tech-email').value = '';
        document.getElementById('tech-status').value = 'active';
        document.getElementById('tech-notes').value = '';
        document.getElementById('tech-delete-btn').style.display = 'none';
      }
      document.getElementById('tech-modal').classList.add('active');
    }
    
    function editTech(id) { openTechModal(id); }
    
    function saveTech() {
      const id = document.getElementById('tech-id').value;
      const name = document.getElementById('tech-name').value.trim();
      const specialties = document.getElementById('tech-specialties').value.trim();
      const phone = document.getElementById('tech-phone').value.trim();
      const email = document.getElementById('tech-email').value.trim();
      const status = document.getElementById('tech-status').value;
      const notes = document.getElementById('tech-notes').value.trim();
      
      if (!name) { showToast('Please enter name', 'error'); return; }
      
      if (id) {
        const i = technicians.findIndex(t => t.id === parseInt(id));
        technicians[i] = { ...technicians[i], name, specialties, phone, email, status, notes };
        showToast('Technician updated');
      } else {
        technicians.push({ id: Math.max(0, ...technicians.map(t => t.id)) + 1, name, specialties, phone, email, status, notes });
        showToast('Technician added');
      }
      
      saveData();
      renderAll();
      closeModal('tech-modal');
    }
    
    function deleteTech() {
      const id = parseInt(document.getElementById('tech-id').value);
      if (!confirm('Delete this technician?')) return;
      technicians = technicians.filter(t => t.id !== id);
      saveData();
      renderAll();
      closeModal('tech-modal');
      showToast('Technician deleted');
    }
    
    // Reports
    function renderReports() {
      // Status chart
      const statusCounts = { open: 0, 'in-progress': 0, 'on-hold': 0, completed: 0, closed: 0 };
      requests.forEach(r => { statusCounts[r.status] = (statusCounts[r.status] || 0) + 1; });
      const total = requests.length || 1;
      
      const colors = { open: '#3b82f6', 'in-progress': '#f59e0b', 'on-hold': '#ec4899', completed: '#10b981', closed: '#6b7280' };
      
      document.getElementById('status-chart').innerHTML = Object.entries(statusCounts).map(([status, count]) => `
        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
          <span style="width: 100px; font-size: 0.875rem; text-transform: capitalize;">${status.replace('-', ' ')}</span>
          <div style="flex: 1; height: 24px; background: var(--gray-200); border-radius: 4px; margin: 0 1rem;">
            <div style="width: ${count / total * 100}%; height: 100%; background: ${colors[status]}; border-radius: 4px;"></div>
          </div>
          <span style="width: 40px; text-align: right; font-weight: 600;">${count}</span>
        </div>
      `).join('');
      
      // Tech workload
      document.getElementById('tech-workload').innerHTML = technicians.map(t => {
        const active = requests.filter(r => r.assignedTo === t.id && r.status !== 'completed' && r.status !== 'closed').length;
        const completed = requests.filter(r => r.assignedTo === t.id && r.status === 'completed').length;
        return `<div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--gray-200);">
          <span>${t.name}</span>
          <span><strong>${active}</strong> active, <strong>${completed}</strong> completed</span>
        </div>`;
      }).join('');
    }
    
    // Exports
    function exportRequests() {
      const headers = ['ID', 'Title', 'Location', 'Category', 'Priority', 'Assigned', 'Status', 'Created', 'Due', 'Requester'];
      const rows = requests.map(r => {
        const loc = locations.find(l => l.id === r.locationId);
        const tech = technicians.find(t => t.id === r.assignedTo);
        return [r.number, r.title, loc?.name || '', r.category, r.priority, tech?.name || '', r.status, r.created, r.due || '', r.requester || ''];
      });
      downloadCSV([headers, ...rows], 'maintenance-requests.csv');
      showToast('Requests exported');
    }
    
    function exportOpenRequests() {
      const open = requests.filter(r => r.status !== 'completed' && r.status !== 'closed');
      const headers = ['ID', 'Title', 'Location', 'Category', 'Priority', 'Assigned', 'Status', 'Created', 'Due'];
      const rows = open.map(r => {
        const loc = locations.find(l => l.id === r.locationId);
        const tech = technicians.find(t => t.id === r.assignedTo);
        return [r.number, r.title, loc?.name || '', r.category, r.priority, tech?.name || '', r.status, r.created, r.due || ''];
      });
      downloadCSV([headers, ...rows], 'open-requests.csv');
      showToast('Open requests exported');
    }
    
    function exportByTech() {
      const headers = ['Technician', 'Active', 'Completed', 'Total'];
      const rows = technicians.map(t => {
        const active = requests.filter(r => r.assignedTo === t.id && r.status !== 'completed' && r.status !== 'closed').length;
        const completed = requests.filter(r => r.assignedTo === t.id && r.status === 'completed').length;
        return [t.name, active, completed, active + completed];
      });
      downloadCSV([headers, ...rows], 'requests-by-technician.csv');
      showToast('Report exported');
    }
    
    function exportByLocation() {
      const headers = ['Location', 'Type', 'Open', 'Total'];
      const rows = locations.map(l => {
        const open = requests.filter(r => r.locationId === l.id && r.status !== 'completed' && r.status !== 'closed').length;
        const total = requests.filter(r => r.locationId === l.id).length;
        return [l.name, l.type, open, total];
      });
      downloadCSV([headers, ...rows], 'requests-by-location.csv');
      showToast('Report exported');
    }
    
    function downloadCSV(data, filename) {
      const csv = data.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
    }
    
    // Helpers
    function formatDate(d) { return d ? new Date(d + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : ''; }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    
    function showToast(msg, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = msg;
      document.getElementById('toast-container').appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); }));
    
    init();
  </script>
</body>
</html>
