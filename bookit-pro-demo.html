<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BookIt Pro - Demo</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #1e293b; line-height: 1.5; }

.app { display: flex; min-height: 100vh; }

/* Sidebar */
.sidebar { width: 240px; background: #fff; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; position: fixed; height: 100vh; }
.sidebar-header { padding: 20px; border-bottom: 1px solid #e2e8f0; }
.logo { display: flex; align-items: center; gap: 12px; }
.logo-icon { font-size: 28px; }
.logo-text { font-weight: 700; font-size: 16px; }
.org-name { font-size: 12px; color: #64748b; }
.demo-badge { display: inline-block; background: #fef3c7; color: #92400e; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }

.nav { flex: 1; padding: 12px 0; }
.nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 20px; cursor: pointer; color: #64748b; font-size: 14px; transition: all 0.2s; }
.nav-item:hover { background: #f8fafc; color: #1e293b; }
.nav-item.active { background: linear-gradient(90deg, #eff6ff, transparent); color: #2563eb; font-weight: 500; border-right: 3px solid #2563eb; }
.nav-divider { height: 1px; background: #e2e8f0; margin: 8px 20px; }

.sidebar-footer { padding: 16px 20px; border-top: 1px solid #e2e8f0; }
.user-info { display: flex; align-items: center; gap: 12px; }
.avatar { width: 36px; height: 36px; border-radius: 50%; background: #2563eb; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; }
.user-name { font-weight: 500; font-size: 14px; }
.user-role { font-size: 12px; color: #64748b; }

/* Main */
.main { flex: 1; margin-left: 240px; padding: 24px; }
.page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
.page-title { font-size: 24px; font-weight: 700; }

/* Cards */
.card { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; padding: 20px; margin-bottom: 16px; }
.card-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; }

/* Stats */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-card { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; padding: 20px; }
.stat-value { font-size: 32px; font-weight: 700; color: #2563eb; }
.stat-label { font-size: 13px; color: #64748b; margin-top: 4px; }

/* Booking link */
.booking-link-card { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 16px; margin-bottom: 24px; }
.booking-link-box { display: flex; align-items: center; gap: 8px; margin-top: 8px; background: #fff; padding: 8px 12px; border-radius: 6px; }
.booking-link-box code { flex: 1; font-size: 13px; color: #64748b; }

/* Dashboard grid */
.dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
@media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr; } }

/* Appointments list */
.appt-list { display: flex; flex-direction: column; gap: 8px; }
.appt-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px; }
.appt-time { font-weight: 600; font-size: 14px; padding-left: 12px; border-left: 3px solid #2563eb; }
.appt-info { flex: 1; }
.appt-client { font-weight: 500; font-size: 14px; }
.appt-service { font-size: 12px; color: #64748b; }
.appt-compact { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9; }

/* Status badges */
.badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: capitalize; }
.badge-confirmed { background: #dcfce7; color: #166534; }
.badge-pending { background: #fef3c7; color: #92400e; }
.badge-completed { background: #dbeafe; color: #1e40af; }
.badge-cancelled { background: #fee2e2; color: #991b1b; }

/* Buttons */
.btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 14px; transition: all 0.2s; }
.btn-primary { background: #2563eb; color: #fff; }
.btn-primary:hover { background: #1d4ed8; }
.btn-secondary { background: #fff; border: 1px solid #e2e8f0; color: #374151; }
.btn-secondary:hover { background: #f8fafc; }
.btn-sm { padding: 6px 12px; font-size: 12px; font-weight: 500; }
.btn-danger { color: #dc2626; border-color: #fecaca; }

/* Tables */
table { width: 100%; border-collapse: collapse; }
th { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 600; }
td { padding: 12px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }

/* Calendar */
.calendar-nav { display: flex; align-items: center; justify-content: center; gap: 24px; margin-bottom: 24px; }
.calendar-grid { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; }
.calendar-header { display: flex; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
.calendar-time-col { width: 70px; padding: 8px; font-size: 11px; color: #64748b; text-align: right; }
.calendar-day-header { flex: 1; padding: 12px; text-align: center; border-left: 1px solid #e2e8f0; }
.calendar-day-name { font-weight: 600; font-size: 12px; }
.calendar-day-num { font-size: 20px; font-weight: 700; }
.calendar-row { display: flex; border-bottom: 1px solid #f1f5f9; }
.calendar-cell { flex: 1; min-height: 60px; padding: 4px; border-left: 1px solid #f1f5f9; position: relative; }
.calendar-appt { padding: 4px 6px; border-radius: 4px; color: #fff; font-size: 11px; cursor: pointer; margin-bottom: 2px; }
.calendar-appt-client { font-weight: 500; }
.calendar-appt-service { opacity: 0.9; font-size: 10px; }

/* Staff view */
.staff-layout { display: grid; grid-template-columns: 280px 1fr; gap: 24px; }
.staff-list-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 4px; }
.staff-list-item:hover { background: #f8fafc; }
.staff-list-item.active { background: #eff6ff; }
.avatar-lg { width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600; font-size: 20px; }

/* Availability */
.avail-grid { display: flex; flex-direction: column; gap: 8px; }
.avail-row { display: flex; align-items: center; gap: 12px; padding: 10px; background: #f8fafc; border-radius: 6px; }
.avail-day { width: 100px; font-weight: 500; }
.avail-toggle { display: flex; align-items: center; gap: 8px; }
.avail-times { display: flex; align-items: center; gap: 8px; }
.avail-times input { padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px; }

/* Service assignments */
.service-checks { display: flex; flex-wrap: wrap; gap: 8px; }
.service-check { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f8fafc; border-radius: 6px; cursor: pointer; }
.service-check input { margin: 0; }
.service-dot { width: 10px; height: 10px; border-radius: 3px; }

/* Services grid */
.services-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
.service-card { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; padding: 20px; }
.service-color { width: 40px; height: 40px; border-radius: 8px; margin-bottom: 12px; }
.service-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
.service-desc { font-size: 13px; color: #64748b; margin-bottom: 12px; }
.service-meta { display: flex; justify-content: space-between; align-items: center; }
.service-price { font-weight: 700; font-size: 18px; }
.service-duration { color: #64748b; }

/* Forms */
.form-group { margin-bottom: 16px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: #374151; }
input, select, textarea { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 14px; font-family: inherit; }
input:focus, select:focus, textarea:focus { outline: none; border-color: #2563eb; }
textarea { min-height: 80px; resize: vertical; }
.checkbox-row { display: flex; gap: 24px; margin-top: 8px; }
.checkbox-row label { display: flex; align-items: center; gap: 8px; cursor: pointer; }

/* Modal */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; }
.modal { background: #fff; border-radius: 16px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #e2e8f0; }
.modal-title { font-size: 18px; font-weight: 600; }
.modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; }
.modal-body { padding: 20px; }
.modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }

/* Settings */
.settings-section { margin-bottom: 24px; }
.settings-section h3 { margin-bottom: 16px; font-size: 16px; }

/* Public booking */
.public-wrap { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #f8fafc; padding: 20px; }
.public-card { background: #fff; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); width: 100%; max-width: 600px; padding: 32px; }
.public-header { text-align: center; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e2e8f0; }
.progress-bar { display: flex; justify-content: space-between; margin-bottom: 32px; }
.progress-step { display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 11px; color: #94a3b8; }
.progress-step.active { color: #2563eb; }
.progress-step.done { color: #10b981; }
.progress-dot { width: 28px; height: 28px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px; }
.progress-step.active .progress-dot { background: #2563eb; color: #fff; }
.progress-step.done .progress-dot { background: #10b981; color: #fff; }
.step-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; }

.public-service-grid { display: flex; flex-direction: column; gap: 8px; }
.public-service-card { display: flex; align-items: center; gap: 12px; padding: 16px; border-radius: 8px; border: 2px solid #e2e8f0; cursor: pointer; }
.public-service-card:hover { border-color: #cbd5e1; }
.public-service-card.selected { border-color: #2563eb; background: #eff6ff; }
.public-staff-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
.public-staff-card { padding: 20px; border-radius: 8px; border: 2px solid #e2e8f0; cursor: pointer; text-align: center; }
.public-staff-card:hover { border-color: #cbd5e1; }
.public-staff-card.selected { border-color: #2563eb; background: #eff6ff; }
.date-grid { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; }
.date-card { min-width: 60px; padding: 12px; border-radius: 8px; border: 2px solid #e2e8f0; cursor: pointer; text-align: center; }
.date-card:hover { border-color: #cbd5e1; }
.date-card.selected { border-color: #2563eb; background: #eff6ff; }
.date-weekday { font-size: 11px; color: #64748b; }
.date-day { font-size: 18px; font-weight: 600; }
.date-month { font-size: 11px; }
.time-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
.time-slot { padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center; cursor: pointer; font-weight: 500; }
.time-slot:hover { border-color: #cbd5e1; background: #f8fafc; }
.time-slot.selected { background: #2563eb; color: #fff; border-color: #2563eb; }
.booking-summary { background: #f8fafc; border-radius: 8px; padding: 16px; }
.summary-row { display: flex; justify-content: space-between; padding: 8px 0; }
.confirm-icon { font-size: 64px; margin-bottom: 16px; }

/* Empty state */
.empty-state { text-align: center; color: #64748b; padding: 40px; }

/* Toast */
.toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 20px; border-radius: 8px; color: #fff; font-weight: 500; z-index: 200; background: #10b981; }
.toast.error { background: #ef4444; }

/* Responsive */
@media (max-width: 768px) {
  .sidebar { display: none; }
  .main { margin-left: 0; }
  .staff-layout { grid-template-columns: 1fr; }
  .form-row { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div id="app"></div>

<script>
// ============================================
// BOOKIT PRO DEMO - localStorage based
// ============================================

const APP = {
  currentView: 'dashboard',
  selectedStaffId: null,
  selectedDate: new Date(),
  filterStatus: 'all',
  modal: null,
  editingItem: null,
  publicMode: false,
  bookingStep: 1,
  bookingData: {},
  toast: null
};

// Sample Data
const DEFAULT_DATA = {
  organization: {
    id: '1',
    name: 'Sunrise Wellness Spa',
    slug: 'sunrise-wellness',
    email: 'hello@sunrisewellness.com',
    phone: '555-100-0001',
    timezone: 'America/New_York',
    buffer_minutes: 15,
    advance_notice_hours: 24,
    max_advance_days: 60,
    cancellation_hours: 24,
    allow_client_cancel: true
  },
  staff: [
    { id: '1', full_name: 'Sarah Johnson', email: 'sarah@spa.com', phone: '555-0101', title: 'Senior Stylist', color: '#2563eb', is_active: true, accepts_bookings: true, role: 'owner' },
    { id: '2', full_name: 'Mike Chen', email: 'mike@spa.com', phone: '555-0102', title: 'Colorist', color: '#7c3aed', is_active: true, accepts_bookings: true, role: 'staff' },
    { id: '3', full_name: 'Emma Davis', email: 'emma@spa.com', phone: '555-0103', title: 'Nail Technician', color: '#ec4899', is_active: true, accepts_bookings: true, role: 'staff' }
  ],
  services: [
    { id: '1', name: 'Haircut', description: 'Precision cut and style', duration_minutes: 45, price: 55, color: '#3b82f6', category: 'Hair', is_active: true },
    { id: '2', name: 'Color', description: 'Full color treatment', duration_minutes: 90, price: 120, color: '#8b5cf6', category: 'Hair', is_active: true },
    { id: '3', name: 'Highlights', description: 'Partial or full highlights', duration_minutes: 120, price: 150, color: '#ec4899', category: 'Hair', is_active: true },
    { id: '4', name: 'Blowout', description: 'Wash and blow dry', duration_minutes: 30, price: 40, color: '#f59e0b', category: 'Hair', is_active: true },
    { id: '5', name: 'Manicure', description: 'Classic manicure', duration_minutes: 30, price: 30, color: '#ef4444', category: 'Nails', is_active: true },
    { id: '6', name: 'Pedicure', description: 'Relaxing pedicure', duration_minutes: 45, price: 45, color: '#06b6d4', category: 'Nails', is_active: true }
  ],
  clients: [
    { id: '1', full_name: 'Jennifer Smith', email: 'jennifer@email.com', phone: '555-1001', notes: 'Prefers afternoon appointments' },
    { id: '2', full_name: 'Robert Brown', email: 'robert@email.com', phone: '555-1002', notes: '' },
    { id: '3', full_name: 'Amanda Wilson', email: 'amanda@email.com', phone: '555-1003', notes: 'VIP client' },
    { id: '4', full_name: 'David Lee', email: 'david@email.com', phone: '555-1004', notes: '' },
    { id: '5', full_name: 'Michelle Garcia', email: 'michelle@email.com', phone: '555-1005', notes: 'New client' }
  ],
  appointments: [],
  availability: [
    // Sarah - Mon-Fri 9-5
    { id: '1', user_id: '1', day_of_week: 1, start_time: '09:00', end_time: '17:00', is_available: true },
    { id: '2', user_id: '1', day_of_week: 2, start_time: '09:00', end_time: '17:00', is_available: true },
    { id: '3', user_id: '1', day_of_week: 3, start_time: '09:00', end_time: '17:00', is_available: true },
    { id: '4', user_id: '1', day_of_week: 4, start_time: '09:00', end_time: '17:00', is_available: true },
    { id: '5', user_id: '1', day_of_week: 5, start_time: '09:00', end_time: '17:00', is_available: true },
    // Mike - Tue-Sat 10-6
    { id: '6', user_id: '2', day_of_week: 2, start_time: '10:00', end_time: '18:00', is_available: true },
    { id: '7', user_id: '2', day_of_week: 3, start_time: '10:00', end_time: '18:00', is_available: true },
    { id: '8', user_id: '2', day_of_week: 4, start_time: '10:00', end_time: '18:00', is_available: true },
    { id: '9', user_id: '2', day_of_week: 5, start_time: '10:00', end_time: '18:00', is_available: true },
    { id: '10', user_id: '2', day_of_week: 6, start_time: '10:00', end_time: '18:00', is_available: true },
    // Emma - Mon-Fri 9-5
    { id: '11', user_id: '3', day_of_week: 1, start_time: '09:00', end_time: '17:00', is_available: true },
    { id: '12', user_id: '3', day_of_week: 2, start_time: '09:00', end_time: '17:00', is_available: true },
    { id: '13', user_id: '3', day_of_week: 3, start_time: '09:00', end_time: '17:00', is_available: true },
    { id: '14', user_id: '3', day_of_week: 4, start_time: '09:00', end_time: '17:00', is_available: true },
    { id: '15', user_id: '3', day_of_week: 5, start_time: '09:00', end_time: '17:00', is_available: true }
  ],
  staffServices: [
    // Sarah does hair services
    { id: '1', user_id: '1', service_id: '1' },
    { id: '2', user_id: '1', service_id: '2' },
    { id: '3', user_id: '1', service_id: '3' },
    { id: '4', user_id: '1', service_id: '4' },
    // Mike does color
    { id: '5', user_id: '2', service_id: '2' },
    { id: '6', user_id: '2', service_id: '3' },
    // Emma does nails
    { id: '7', user_id: '3', service_id: '5' },
    { id: '8', user_id: '3', service_id: '6' }
  ]
};

// Generate sample appointments
function generateSampleAppointments() {
  const appts = [];
  const today = new Date();
  const statuses = ['confirmed', 'confirmed', 'confirmed', 'completed', 'pending'];
  
  // Create appointments over the past week and next week
  for (let d = -7; d <= 7; d++) {
    const date = new Date(today);
    date.setDate(date.getDate() + d);
    const dayOfWeek = date.getDay();
    
    // Skip Sundays
    if (dayOfWeek === 0) continue;
    
    // 2-4 appointments per day
    const numAppts = 2 + Math.floor(Math.random() * 3);
    const usedSlots = [];
    
    for (let i = 0; i < numAppts; i++) {
      const staffIdx = Math.floor(Math.random() * 3);
      const staff = DEFAULT_DATA.staff[staffIdx];
      
      // Get services this staff can do
      const staffServiceIds = DEFAULT_DATA.staffServices
        .filter(ss => ss.user_id === staff.id)
        .map(ss => ss.service_id);
      const availableServices = DEFAULT_DATA.services.filter(s => staffServiceIds.includes(s.id));
      if (availableServices.length === 0) continue;
      
      const service = availableServices[Math.floor(Math.random() * availableServices.length)];
      const client = DEFAULT_DATA.clients[Math.floor(Math.random() * DEFAULT_DATA.clients.length)];
      
      // Random hour between 9-16
      let hour = 9 + Math.floor(Math.random() * 7);
      const slotKey = `${staff.id}-${hour}`;
      if (usedSlots.includes(slotKey)) continue;
      usedSlots.push(slotKey);
      
      const startTime = new Date(date);
      startTime.setHours(hour, 0, 0, 0);
      const endTime = new Date(startTime.getTime() + service.duration_minutes * 60000);
      
      const status = d < 0 ? 'completed' : statuses[Math.floor(Math.random() * statuses.length)];
      
      appts.push({
        id: `appt-${appts.length + 1}`,
        user_id: staff.id,
        client_id: client.id,
        service_id: service.id,
        start_time: startTime.toISOString(),
        end_time: endTime.toISOString(),
        status: status,
        notes: ''
      });
    }
  }
  
  return appts;
}

// Data Management
function loadData() {
  const saved = localStorage.getItem('bookitpro_demo');
  if (saved) {
    return JSON.parse(saved);
  }
  const data = { ...DEFAULT_DATA };
  data.appointments = generateSampleAppointments();
  saveData(data);
  return data;
}

function saveData(data) {
  localStorage.setItem('bookitpro_demo', JSON.stringify(data));
}

function getData() {
  return loadData();
}

// Helpers
function formatDate(d) {
  return new Date(d).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
}

function formatTime(d) {
  return new Date(d).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
}

function formatDateTime(d) {
  return `${formatDate(d)} at ${formatTime(d)}`;
}

function formatMoney(n) {
  return '$' + Number(n || 0).toFixed(2);
}

function formatTimeStr(timeStr) {
  const [h, m] = timeStr.split(':').map(Number);
  const ampm = h >= 12 ? 'PM' : 'AM';
  const hour = h % 12 || 12;
  return `${hour}:${String(m).padStart(2, '0')} ${ampm}`;
}

function getWeekDates(startDate) {
  const start = new Date(startDate);
  start.setDate(start.getDate() - start.getDay());
  return Array.from({ length: 7 }, (_, i) => {
    const d = new Date(start);
    d.setDate(d.getDate() + i);
    return d;
  });
}

function generateId() {
  return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
}

function showToast(msg, type = 'success') {
  APP.toast = { msg, type };
  render();
  setTimeout(() => { APP.toast = null; render(); }, 3000);
}

function getStaffById(id) {
  return getData().staff.find(s => s.id === id);
}

function getServiceById(id) {
  return getData().services.find(s => s.id === id);
}

function getClientById(id) {
  return getData().clients.find(c => c.id === id);
}

function getStaffForService(serviceId) {
  const data = getData();
  const assignments = data.staffServices.filter(ss => ss.service_id === serviceId);
  if (assignments.length === 0) {
    return data.staff.filter(s => s.is_active && s.accepts_bookings);
  }
  return data.staff.filter(s => 
    s.is_active && 
    s.accepts_bookings && 
    assignments.some(a => a.user_id === s.id)
  );
}

function getStaffAvailability(staffId, date) {
  const data = getData();
  const dayOfWeek = date.getDay();
  const avail = data.availability.find(a => a.user_id === staffId && a.day_of_week === dayOfWeek && a.is_available);
  if (avail) {
    return { start: avail.start_time, end: avail.end_time };
  }
  return null;
}

function getAvailableSlots(staffId, date, durationMinutes) {
  const data = getData();
  const avail = getStaffAvailability(staffId, date);
  if (!avail) return [];
  
  const dateStr = date.toISOString().split('T')[0];
  const buffer = data.organization.buffer_minutes || 15;
  const slots = [];
  
  const [startH, startM] = avail.start.split(':').map(Number);
  const [endH, endM] = avail.end.split(':').map(Number);
  
  let currentMinutes = startH * 60 + startM;
  const endMinutes = endH * 60 + endM;
  
  const dayAppointments = data.appointments.filter(a => 
    a.user_id === staffId && 
    a.start_time.startsWith(dateStr) &&
    a.status !== 'cancelled'
  );
  
  while (currentMinutes + durationMinutes <= endMinutes) {
    const slotStart = `${String(Math.floor(currentMinutes / 60)).padStart(2, '0')}:${String(currentMinutes % 60).padStart(2, '0')}`;
    const slotEndMinutes = currentMinutes + durationMinutes;
    const slotEnd = `${String(Math.floor(slotEndMinutes / 60)).padStart(2, '0')}:${String(slotEndMinutes % 60).padStart(2, '0')}`;
    
    const hasConflict = dayAppointments.some(a => {
      const apptStart = a.start_time.split('T')[1].substring(0, 5);
      const apptEnd = a.end_time.split('T')[1].substring(0, 5);
      return !(slotEnd <= apptStart || slotStart >= apptEnd);
    });
    
    if (!hasConflict) {
      slots.push({ time: slotStart, display: formatTimeStr(slotStart) });
    }
    
    currentMinutes += 30;
  }
  
  return slots;
}

// Stats
function getStats() {
  const data = getData();
  const now = new Date();
  const today = now.toISOString().split('T')[0];
  const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  
  const todayAppts = data.appointments.filter(a => a.start_time.startsWith(today) && a.status !== 'cancelled');
  const weekCompleted = data.appointments.filter(a => new Date(a.start_time) >= weekAgo && a.status === 'completed');
  const monthAppts = data.appointments.filter(a => new Date(a.start_time) >= monthStart && a.status !== 'cancelled');
  
  const monthRevenue = monthAppts.reduce((sum, a) => {
    const service = getServiceById(a.service_id);
    return sum + (service?.price || 0);
  }, 0);
  
  return {
    todayCount: todayAppts.length,
    weekCompleted: weekCompleted.length,
    monthRevenue,
    totalClients: data.clients.length
  };
}

function getTodayAppointments() {
  const data = getData();
  const today = new Date().toISOString().split('T')[0];
  return data.appointments
    .filter(a => a.start_time.startsWith(today) && a.status !== 'cancelled')
    .sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
}

function getUpcomingAppointments() {
  const data = getData();
  const now = new Date();
  return data.appointments
    .filter(a => new Date(a.start_time) >= now && a.status !== 'cancelled' && a.status !== 'completed')
    .sort((a, b) => new Date(a.start_time) - new Date(b.start_time))
    .slice(0, 10);
}

// CRUD Operations
function saveStaff(formData) {
  const data = getData();
  if (APP.editingItem) {
    const idx = data.staff.findIndex(s => s.id === APP.editingItem.id);
    if (idx !== -1) {
      data.staff[idx] = { ...data.staff[idx], ...formData };
    }
  } else {
    data.staff.push({ id: generateId(), ...formData });
  }
  saveData(data);
  APP.modal = null;
  APP.editingItem = null;
  showToast('Staff saved');
  render();
}

function saveService(formData) {
  const data = getData();
  if (APP.editingItem) {
    const idx = data.services.findIndex(s => s.id === APP.editingItem.id);
    if (idx !== -1) {
      data.services[idx] = { ...data.services[idx], ...formData };
    }
  } else {
    data.services.push({ id: generateId(), ...formData });
  }
  saveData(data);
  APP.modal = null;
  APP.editingItem = null;
  showToast('Service saved');
  render();
}

function saveClient(formData) {
  const data = getData();
  if (APP.editingItem) {
    const idx = data.clients.findIndex(c => c.id === APP.editingItem.id);
    if (idx !== -1) {
      data.clients[idx] = { ...data.clients[idx], ...formData };
    }
  } else {
    data.clients.push({ id: generateId(), ...formData });
  }
  saveData(data);
  APP.modal = null;
  APP.editingItem = null;
  showToast('Client saved');
  render();
}

function saveAppointment(formData) {
  const data = getData();
  const service = getServiceById(formData.service_id);
  const startTime = new Date(`${formData.date}T${formData.time}`);
  const endTime = new Date(startTime.getTime() + service.duration_minutes * 60000);
  
  const apptData = {
    user_id: formData.user_id,
    client_id: formData.client_id,
    service_id: formData.service_id,
    start_time: startTime.toISOString(),
    end_time: endTime.toISOString(),
    status: formData.status,
    notes: formData.notes || ''
  };
  
  if (APP.editingItem) {
    const idx = data.appointments.findIndex(a => a.id === APP.editingItem.id);
    if (idx !== -1) {
      data.appointments[idx] = { ...data.appointments[idx], ...apptData };
    }
  } else {
    data.appointments.push({ id: generateId(), ...apptData });
  }
  saveData(data);
  APP.modal = null;
  APP.editingItem = null;
  showToast('Appointment saved');
  render();
}

function cancelAppointment(id) {
  if (!confirm('Cancel this appointment?')) return;
  const data = getData();
  const idx = data.appointments.findIndex(a => a.id === id);
  if (idx !== -1) {
    data.appointments[idx].status = 'cancelled';
    saveData(data);
    showToast('Appointment cancelled');
    render();
  }
}

function completeAppointment(id) {
  const data = getData();
  const idx = data.appointments.findIndex(a => a.id === id);
  if (idx !== -1) {
    data.appointments[idx].status = 'completed';
    saveData(data);
    showToast('Marked as completed');
    render();
  }
}

function toggleStaffService(staffId, serviceId, assigned) {
  const data = getData();
  if (assigned) {
    data.staffServices.push({ id: generateId(), user_id: staffId, service_id: serviceId });
  } else {
    data.staffServices = data.staffServices.filter(ss => !(ss.user_id === staffId && ss.service_id === serviceId));
  }
  saveData(data);
  render();
}

function saveAvailability(staffId, dayOfWeek, startTime, endTime, isAvailable) {
  const data = getData();
  const existing = data.availability.find(a => a.user_id === staffId && a.day_of_week === dayOfWeek);
  if (existing) {
    existing.start_time = startTime;
    existing.end_time = endTime;
    existing.is_available = isAvailable;
  } else {
    data.availability.push({
      id: generateId(),
      user_id: staffId,
      day_of_week: dayOfWeek,
      start_time: startTime,
      end_time: endTime,
      is_available: isAvailable
    });
  }
  saveData(data);
  render();
}

function saveSettings(formData) {
  const data = getData();
  data.organization = { ...data.organization, ...formData };
  saveData(data);
  showToast('Settings saved');
  render();
}

// Render Functions
function render() {
  const app = document.getElementById('app');
  
  if (APP.publicMode) {
    app.innerHTML = renderPublicBooking();
  } else {
    app.innerHTML = `
      <div class="app">
        ${renderSidebar()}
        <main class="main">
          ${renderCurrentView()}
        </main>
        ${APP.modal ? renderModal() : ''}
        ${APP.toast ? `<div class="toast ${APP.toast.type === 'error' ? 'error' : ''}">${APP.toast.msg}</div>` : ''}
      </div>
    `;
  }
  
  attachEventListeners();
}

function renderSidebar() {
  const data = getData();
  const staff = data.staff[0]; // Owner
  
  return `
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <span class="logo-icon">üìÖ</span>
          <div>
            <div class="logo-text">BookIt Pro <span class="demo-badge">DEMO</span></div>
            <div class="org-name">${data.organization.name}</div>
          </div>
        </div>
      </div>
      
      <nav class="nav">
        <div class="nav-item ${APP.currentView === 'dashboard' ? 'active' : ''}" data-view="dashboard">üìä Dashboard</div>
        <div class="nav-item ${APP.currentView === 'calendar' ? 'active' : ''}" data-view="calendar">üìÖ Calendar</div>
        <div class="nav-item ${APP.currentView === 'appointments' ? 'active' : ''}" data-view="appointments">üìã Appointments</div>
        <div class="nav-divider"></div>
        <div class="nav-item ${APP.currentView === 'staff' ? 'active' : ''}" data-view="staff">üë• Staff</div>
        <div class="nav-item ${APP.currentView === 'services' ? 'active' : ''}" data-view="services">üíá Services</div>
        <div class="nav-item ${APP.currentView === 'clients' ? 'active' : ''}" data-view="clients">üë§ Clients</div>
        <div class="nav-divider"></div>
        <div class="nav-item ${APP.currentView === 'settings' ? 'active' : ''}" data-view="settings">‚öôÔ∏è Settings</div>
      </nav>
      
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="avatar" style="background: ${staff.color}">${staff.full_name.charAt(0)}</div>
          <div>
            <div class="user-name">${staff.full_name}</div>
            <div class="user-role">${staff.role}</div>
          </div>
        </div>
      </div>
    </aside>
  `;
}

function renderCurrentView() {
  switch (APP.currentView) {
    case 'dashboard': return renderDashboard();
    case 'calendar': return renderCalendar();
    case 'appointments': return renderAppointments();
    case 'staff': return renderStaff();
    case 'services': return renderServices();
    case 'clients': return renderClients();
    case 'settings': return renderSettings();
    default: return renderDashboard();
  }
}

function renderDashboard() {
  const data = getData();
  const stats = getStats();
  const todayAppts = getTodayAppointments();
  const upcomingAppts = getUpcomingAppointments();
  
  return `
    <div class="page-header">
      <h1 class="page-title">Dashboard</h1>
      <button class="btn btn-primary" data-action="new-appointment">+ New Appointment</button>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">${stats.todayCount}</div>
        <div class="stat-label">Today's Appointments</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${stats.weekCompleted}</div>
        <div class="stat-label">Completed This Week</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" style="color: #10b981">$${stats.monthRevenue.toFixed(0)}</div>
        <div class="stat-label">Revenue This Month</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${stats.totalClients}</div>
        <div class="stat-label">Total Clients</div>
      </div>
    </div>
    
    <div class="booking-link-card">
      <div>
        <strong>üìé Public Booking Link</strong>
        <p style="font-size: 13px; color: #64748b; margin: 4px 0;">Share this link with clients to let them book online</p>
      </div>
      <div class="booking-link-box">
        <code>${window.location.origin}${window.location.pathname}?book=${data.organization.slug}</code>
        <button class="btn btn-sm btn-secondary" data-action="open-public">Preview</button>
      </div>
    </div>
    
    <div class="dashboard-grid">
      <div class="card">
        <h2 class="card-title">Today's Schedule</h2>
        ${todayAppts.length === 0 ? '<p class="empty-state">No appointments today</p>' : `
          <div class="appt-list">
            ${todayAppts.map(a => {
              const client = getClientById(a.client_id);
              const service = getServiceById(a.service_id);
              const staff = getStaffById(a.user_id);
              return `
                <div class="appt-item">
                  <div class="appt-time" style="border-left-color: ${staff?.color || '#2563eb'}">${formatTime(a.start_time)}</div>
                  <div class="appt-info">
                    <div class="appt-client">${client?.full_name || 'Unknown'}</div>
                    <div class="appt-service">${service?.name} with ${staff?.full_name}</div>
                  </div>
                  <div>
                    ${a.status === 'confirmed' ? `<button class="btn btn-sm btn-secondary" data-action="complete-appt" data-id="${a.id}">‚úì Complete</button>` : ''}
                    <span class="badge badge-${a.status}">${a.status}</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `}
      </div>
      
      <div class="card">
        <h2 class="card-title">Upcoming Appointments</h2>
        ${upcomingAppts.length === 0 ? '<p class="empty-state">No upcoming appointments</p>' : `
          <div class="appt-list">
            ${upcomingAppts.map(a => {
              const client = getClientById(a.client_id);
              const service = getServiceById(a.service_id);
              return `
                <div class="appt-compact">
                  <div>
                    <div style="font-weight: 500">${client?.full_name}</div>
                    <div style="font-size: 12px; color: #64748b">${service?.name}</div>
                  </div>
                  <div style="text-align: right; font-size: 13px">
                    <div>${formatDate(a.start_time)}</div>
                    <div style="color: #64748b">${formatTime(a.start_time)}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `}
      </div>
    </div>
  `;
}

function renderCalendar() {
  const data = getData();
  const weekDates = getWeekDates(APP.selectedDate);
  const hours = Array.from({ length: 10 }, (_, i) => i + 8); // 8 AM to 5 PM
  const activeStaff = data.staff.filter(s => s.is_active && s.accepts_bookings);
  
  return `
    <div class="page-header">
      <h1 class="page-title">Calendar</h1>
      <div style="display: flex; gap: 8px; align-items: center">
        <select id="staff-filter" style="padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
          <option value="">All Staff</option>
          ${activeStaff.map(s => `<option value="${s.id}" ${APP.selectedStaffId === s.id ? 'selected' : ''}>${s.full_name}</option>`).join('')}
        </select>
        <button class="btn btn-primary" data-action="new-appointment">+ New</button>
      </div>
    </div>
    
    <div class="calendar-nav">
      <button class="btn btn-secondary" data-action="prev-week">‚Üê Prev</button>
      <h2>${weekDates[0].toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekDates[6].toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</h2>
      <button class="btn btn-secondary" data-action="next-week">Next ‚Üí</button>
    </div>
    
    <div class="calendar-grid">
      <div class="calendar-header">
        <div class="calendar-time-col"></div>
        ${weekDates.map(d => `
          <div class="calendar-day-header">
            <div class="calendar-day-name">${d.toLocaleDateString('en-US', { weekday: 'short' })}</div>
            <div class="calendar-day-num">${d.getDate()}</div>
          </div>
        `).join('')}
      </div>
      
      ${hours.map(hour => `
        <div class="calendar-row">
          <div class="calendar-time-col">${hour > 12 ? hour - 12 : hour} ${hour >= 12 ? 'PM' : 'AM'}</div>
          ${weekDates.map(d => {
            const dateStr = d.toISOString().split('T')[0];
            const filteredStaff = APP.selectedStaffId ? activeStaff.filter(s => s.id === APP.selectedStaffId) : activeStaff;
            const cellAppts = data.appointments.filter(a => 
              a.start_time.startsWith(dateStr) &&
              new Date(a.start_time).getHours() === hour &&
              a.status !== 'cancelled' &&
              filteredStaff.some(s => s.id === a.user_id)
            );
            
            return `
              <div class="calendar-cell">
                ${cellAppts.map(a => {
                  const client = getClientById(a.client_id);
                  const service = getServiceById(a.service_id);
                  const staff = getStaffById(a.user_id);
                  return `
                    <div class="calendar-appt" style="background: ${staff?.color || '#2563eb'}" data-action="edit-appt" data-id="${a.id}">
                      <div class="calendar-appt-client">${client?.full_name}</div>
                      <div class="calendar-appt-service">${service?.name}</div>
                    </div>
                  `;
                }).join('')}
              </div>
            `;
          }).join('')}
        </div>
      `).join('')}
    </div>
  `;
}

function renderAppointments() {
  const data = getData();
  let filtered = data.appointments;
  if (APP.filterStatus !== 'all') {
    filtered = filtered.filter(a => a.status === APP.filterStatus);
  }
  filtered = filtered.sort((a, b) => new Date(b.start_time) - new Date(a.start_time));
  
  return `
    <div class="page-header">
      <h1 class="page-title">Appointments</h1>
      <button class="btn btn-primary" data-action="new-appointment">+ New Appointment</button>
    </div>
    
    <div style="margin-bottom: 16px">
      <select id="status-filter" style="padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
        <option value="all" ${APP.filterStatus === 'all' ? 'selected' : ''}>All Statuses</option>
        <option value="pending" ${APP.filterStatus === 'pending' ? 'selected' : ''}>Pending</option>
        <option value="confirmed" ${APP.filterStatus === 'confirmed' ? 'selected' : ''}>Confirmed</option>
        <option value="completed" ${APP.filterStatus === 'completed' ? 'selected' : ''}>Completed</option>
        <option value="cancelled" ${APP.filterStatus === 'cancelled' ? 'selected' : ''}>Cancelled</option>
      </select>
    </div>
    
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Client</th>
            <th>Service</th>
            <th>Staff</th>
            <th>Price</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${filtered.length === 0 ? '<tr><td colspan="7" class="empty-state">No appointments found</td></tr>' : 
            filtered.map(a => {
              const client = getClientById(a.client_id);
              const service = getServiceById(a.service_id);
              const staff = getStaffById(a.user_id);
              return `
                <tr>
                  <td>${formatDateTime(a.start_time)}</td>
                  <td><strong>${client?.full_name}</strong><br><span style="font-size: 12px; color: #64748b">${client?.email}</span></td>
                  <td>${service?.name}<br><span style="font-size: 12px; color: #64748b">${service?.duration_minutes} min</span></td>
                  <td>${staff?.full_name}</td>
                  <td>${formatMoney(service?.price)}</td>
                  <td><span class="badge badge-${a.status}">${a.status}</span></td>
                  <td>
                    <button class="btn btn-sm btn-secondary" data-action="edit-appt" data-id="${a.id}">Edit</button>
                    ${a.status === 'confirmed' ? `
                      <button class="btn btn-sm btn-secondary" style="margin-left: 4px" data-action="complete-appt" data-id="${a.id}">Complete</button>
                      <button class="btn btn-sm btn-secondary btn-danger" style="margin-left: 4px" data-action="cancel-appt" data-id="${a.id}">Cancel</button>
                    ` : ''}
                  </td>
                </tr>
              `;
            }).join('')
          }
        </tbody>
      </table>
    </div>
  `;
}

function renderStaff() {
  const data = getData();
  const selectedStaff = APP.selectedStaffId ? data.staff.find(s => s.id === APP.selectedStaffId) : null;
  const staffAvail = selectedStaff ? data.availability.filter(a => a.user_id === selectedStaff.id) : [];
  const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  
  return `
    <div class="page-header">
      <h1 class="page-title">Staff</h1>
      <button class="btn btn-primary" data-action="new-staff">+ Add Staff</button>
    </div>
    
    <div class="staff-layout">
      <div class="card">
        <h3 style="margin-bottom: 16px">Team Members</h3>
        ${data.staff.map(s => `
          <div class="staff-list-item ${APP.selectedStaffId === s.id ? 'active' : ''}" data-action="select-staff" data-id="${s.id}">
            <div class="avatar" style="background: ${s.color}">${s.full_name.charAt(0)}</div>
            <div>
              <div style="font-weight: 500">${s.full_name}</div>
              <div style="font-size: 12px; color: #64748b">${s.title || s.role}</div>
            </div>
            ${!s.is_active ? '<span class="badge" style="background: #f3f4f6; color: #6b7280">Inactive</span>' : ''}
          </div>
        `).join('')}
      </div>
      
      <div>
        ${selectedStaff ? `
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px">
              <div style="display: flex; gap: 16px; align-items: center">
                <div class="avatar-lg" style="background: ${selectedStaff.color}">${selectedStaff.full_name.charAt(0)}</div>
                <div>
                  <h2 style="margin: 0">${selectedStaff.full_name}</h2>
                  <p style="color: #64748b; margin: 4px 0">${selectedStaff.title || selectedStaff.role}</p>
                  <p style="font-size: 13px">${selectedStaff.email}</p>
                </div>
              </div>
              <button class="btn btn-secondary" data-action="edit-staff" data-id="${selectedStaff.id}">Edit</button>
            </div>
          </div>
          
          <div class="card" style="margin-top: 16px">
            <h3 style="margin-bottom: 16px">Weekly Availability</h3>
            <div class="avail-grid">
              ${days.map((day, i) => {
                const dayAvail = staffAvail.find(a => a.day_of_week === i);
                return `
                  <div class="avail-row">
                    <div class="avail-day">${day}</div>
                    <label class="avail-toggle">
                      <input type="checkbox" ${dayAvail?.is_available ? 'checked' : ''} data-action="toggle-avail" data-staff="${selectedStaff.id}" data-day="${i}">
                      Available
                    </label>
                    ${dayAvail?.is_available ? `
                      <div class="avail-times">
                        <input type="time" value="${dayAvail.start_time}" data-action="set-avail-start" data-staff="${selectedStaff.id}" data-day="${i}">
                        <span>to</span>
                        <input type="time" value="${dayAvail.end_time}" data-action="set-avail-end" data-staff="${selectedStaff.id}" data-day="${i}">
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('')}
            </div>
          </div>
          
          <div class="card" style="margin-top: 16px">
            <h3 style="margin-bottom: 16px">Services Offered</h3>
            <p style="font-size: 13px; color: #64748b; margin-bottom: 12px">Select which services this staff member can perform</p>
            <div class="service-checks">
              ${data.services.filter(s => s.is_active).map(service => {
                const assigned = data.staffServices.some(ss => ss.user_id === selectedStaff.id && ss.service_id === service.id);
                return `
                  <label class="service-check">
                    <input type="checkbox" ${assigned ? 'checked' : ''} data-action="toggle-staff-service" data-staff="${selectedStaff.id}" data-service="${service.id}">
                    <span class="service-dot" style="background: ${service.color}"></span>
                    ${service.name}
                  </label>
                `;
              }).join('')}
            </div>
          </div>
        ` : '<div class="card"><p class="empty-state">Select a staff member to view details</p></div>'}
      </div>
    </div>
  `;
}

function renderServices() {
  const data = getData();
  
  return `
    <div class="page-header">
      <h1 class="page-title">Services</h1>
      <button class="btn btn-primary" data-action="new-service">+ Add Service</button>
    </div>
    
    <div class="services-grid">
      ${data.services.map(s => `
        <div class="service-card">
          <div class="service-color" style="background: ${s.color}"></div>
          <h3 class="service-name">${s.name}</h3>
          <p class="service-desc">${s.description || 'No description'}</p>
          <div class="service-meta">
            <div>
              <span class="service-price">${formatMoney(s.price)}</span>
              <span class="service-duration">${s.duration_minutes} min</span>
            </div>
            <button class="btn btn-sm btn-secondary" data-action="edit-service" data-id="${s.id}">Edit</button>
          </div>
          ${!s.is_active ? '<span class="badge" style="background: #f3f4f6; color: #6b7280; margin-top: 8px">Inactive</span>' : ''}
        </div>
      `).join('')}
    </div>
    ${data.services.length === 0 ? '<p class="empty-state">No services yet. Add your first service to get started.</p>' : ''}
  `;
}

function renderClients() {
  const data = getData();
  
  return `
    <div class="page-header">
      <h1 class="page-title">Clients</h1>
      <button class="btn btn-primary" data-action="new-client">+ Add Client</button>
    </div>
    
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Appointments</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${data.clients.length === 0 ? '<tr><td colspan="5" class="empty-state">No clients yet</td></tr>' :
            data.clients.map(c => {
              const apptCount = data.appointments.filter(a => a.client_id === c.id).length;
              return `
                <tr>
                  <td><strong>${c.full_name}</strong></td>
                  <td>${c.email}</td>
                  <td>${c.phone || '-'}</td>
                  <td>${apptCount}</td>
                  <td><button class="btn btn-sm btn-secondary" data-action="edit-client" data-id="${c.id}">Edit</button></td>
                </tr>
              `;
            }).join('')
          }
        </tbody>
      </table>
    </div>
  `;
}

function renderSettings() {
  const data = getData();
  const org = data.organization;
  
  return `
    <div class="page-header">
      <h1 class="page-title">Settings</h1>
    </div>
    
    <form id="settings-form">
      <div class="card settings-section">
        <h3>Business Information</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Business Name</label>
            <input type="text" name="name" value="${org.name}" required>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" value="${org.email || ''}">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" name="phone" value="${org.phone || ''}">
          </div>
          <div class="form-group">
            <label>Timezone</label>
            <select name="timezone">
              <option value="America/New_York" ${org.timezone === 'America/New_York' ? 'selected' : ''}>Eastern Time</option>
              <option value="America/Chicago" ${org.timezone === 'America/Chicago' ? 'selected' : ''}>Central Time</option>
              <option value="America/Denver" ${org.timezone === 'America/Denver' ? 'selected' : ''}>Mountain Time</option>
              <option value="America/Los_Angeles" ${org.timezone === 'America/Los_Angeles' ? 'selected' : ''}>Pacific Time</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="card settings-section">
        <h3>Booking Rules</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Buffer Between Appointments (minutes)</label>
            <input type="number" name="buffer_minutes" value="${org.buffer_minutes || 15}">
          </div>
          <div class="form-group">
            <label>Minimum Notice (hours)</label>
            <input type="number" name="advance_notice_hours" value="${org.advance_notice_hours || 24}">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Max Days in Advance</label>
            <input type="number" name="max_advance_days" value="${org.max_advance_days || 60}">
          </div>
          <div class="form-group">
            <label>Cancellation Window (hours)</label>
            <input type="number" name="cancellation_hours" value="${org.cancellation_hours || 24}">
          </div>
        </div>
        <div class="checkbox-row">
          <label><input type="checkbox" name="allow_client_cancel" ${org.allow_client_cancel ? 'checked' : ''}> Allow clients to cancel online</label>
        </div>
      </div>
      
      <button type="submit" class="btn btn-primary">Save Settings</button>
    </form>
    
    <div class="card" style="margin-top: 24px; background: #fef3c7; border-color: #fcd34d">
      <h3 style="color: #92400e; margin-bottom: 8px">‚ö†Ô∏è Demo Data</h3>
      <p style="font-size: 13px; color: #92400e; margin-bottom: 16px">Reset all data to defaults</p>
      <button class="btn btn-secondary btn-danger" data-action="reset-data">Reset Demo Data</button>
    </div>
  `;
}

function renderModal() {
  const data = getData();
  let title = '';
  let content = '';
  
  switch (APP.modal) {
    case 'staff':
      title = APP.editingItem ? 'Edit Staff' : 'Add Staff';
      const staff = APP.editingItem || { full_name: '', email: '', phone: '', title: '', color: '#2563eb', is_active: true, accepts_bookings: true, role: 'staff' };
      content = `
        <form id="staff-form">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" name="full_name" value="${staff.full_name}" required>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" value="${staff.email}" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" name="phone" value="${staff.phone || ''}">
            </div>
            <div class="form-group">
              <label>Title</label>
              <input type="text" name="title" placeholder="e.g., Senior Stylist" value="${staff.title || ''}">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Calendar Color</label>
              <input type="color" name="color" value="${staff.color}">
            </div>
            <div class="form-group">
              <label>Role</label>
              <select name="role">
                <option value="staff" ${staff.role === 'staff' ? 'selected' : ''}>Staff</option>
                <option value="admin" ${staff.role === 'admin' ? 'selected' : ''}>Admin</option>
                <option value="owner" ${staff.role === 'owner' ? 'selected' : ''}>Owner</option>
              </select>
            </div>
          </div>
          <div class="checkbox-row">
            <label><input type="checkbox" name="is_active" ${staff.is_active ? 'checked' : ''}> Active</label>
            <label><input type="checkbox" name="accepts_bookings" ${staff.accepts_bookings ? 'checked' : ''}> Accepts Bookings</label>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" data-action="close-modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      `;
      break;
      
    case 'service':
      title = APP.editingItem ? 'Edit Service' : 'Add Service';
      const service = APP.editingItem || { name: '', description: '', duration_minutes: 60, price: 0, color: '#10b981', category: '', is_active: true };
      content = `
        <form id="service-form">
          <div class="form-group">
            <label>Service Name</label>
            <input type="text" name="name" value="${service.name}" required>
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea name="description">${service.description || ''}</textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Duration (minutes)</label>
              <input type="number" name="duration_minutes" value="${service.duration_minutes}" required>
            </div>
            <div class="form-group">
              <label>Price</label>
              <input type="number" name="price" step="0.01" value="${service.price}" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Color</label>
              <input type="color" name="color" value="${service.color}">
            </div>
            <div class="form-group">
              <label>Category</label>
              <input type="text" name="category" placeholder="e.g., Hair, Nails" value="${service.category || ''}">
            </div>
          </div>
          <div class="checkbox-row">
            <label><input type="checkbox" name="is_active" ${service.is_active ? 'checked' : ''}> Active</label>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" data-action="close-modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      `;
      break;
      
    case 'client':
      title = APP.editingItem ? 'Edit Client' : 'Add Client';
      const client = APP.editingItem || { full_name: '', email: '', phone: '', notes: '' };
      content = `
        <form id="client-form">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" name="full_name" value="${client.full_name}" required>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" value="${client.email}" required>
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" name="phone" value="${client.phone || ''}">
          </div>
          <div class="form-group">
            <label>Notes</label>
            <textarea name="notes">${client.notes || ''}</textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" data-action="close-modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      `;
      break;
      
    case 'appointment':
      title = APP.editingItem ? 'Edit Appointment' : 'New Appointment';
      const appt = APP.editingItem || { client_id: '', service_id: '', user_id: '', start_time: '', status: 'confirmed', notes: '' };
      const apptDate = appt.start_time ? appt.start_time.split('T')[0] : new Date().toISOString().split('T')[0];
      const apptTime = appt.start_time ? appt.start_time.split('T')[1]?.substring(0, 5) : '09:00';
      content = `
        <form id="appointment-form">
          <div class="form-group">
            <label>Client</label>
            <select name="client_id" required>
              <option value="">Select...</option>
              ${data.clients.map(c => `<option value="${c.id}" ${appt.client_id === c.id ? 'selected' : ''}>${c.full_name}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label>Service</label>
            <select name="service_id" required>
              <option value="">Select...</option>
              ${data.services.filter(s => s.is_active).map(s => `<option value="${s.id}" ${appt.service_id === s.id ? 'selected' : ''}>${s.name} (${s.duration_minutes} min)</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label>Staff</label>
            <select name="user_id" required>
              <option value="">Select...</option>
              ${data.staff.filter(s => s.is_active && s.accepts_bookings).map(s => `<option value="${s.id}" ${appt.user_id === s.id ? 'selected' : ''}>${s.full_name}</option>`).join('')}
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Date</label>
              <input type="date" name="date" value="${apptDate}" required>
            </div>
            <div class="form-group">
              <label>Time</label>
              <input type="time" name="time" value="${apptTime}" required>
            </div>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select name="status">
              <option value="pending" ${appt.status === 'pending' ? 'selected' : ''}>Pending</option>
              <option value="confirmed" ${appt.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
              <option value="completed" ${appt.status === 'completed' ? 'selected' : ''}>Completed</option>
              <option value="cancelled" ${appt.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
            </select>
          </div>
          <div class="form-group">
            <label>Notes</label>
            <textarea name="notes">${appt.notes || ''}</textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" data-action="close-modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      `;
      break;
  }
  
  return `
    <div class="modal-overlay" data-action="close-modal">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">${title}</h2>
          <button class="modal-close" data-action="close-modal">√ó</button>
        </div>
        <div class="modal-body">${content}</div>
      </div>
    </div>
  `;
}

function renderPublicBooking() {
  const data = getData();
  const org = data.organization;
  const services = data.services.filter(s => s.is_active);
  const { service, staff: selectedStaff, date, time, client } = APP.bookingData;
  
  const availableStaff = service ? getStaffForService(service.id) : [];
  
  // Generate next 30 days
  const dates = [];
  const today = new Date();
  for (let i = 1; i <= 30; i++) {
    const d = new Date(today);
    d.setDate(d.getDate() + i);
    dates.push(d);
  }
  
  const availableSlots = selectedStaff && APP.bookingData.selectedDate && service ? 
    getAvailableSlots(selectedStaff.id, APP.bookingData.selectedDate, service.duration_minutes) : [];
  
  let stepContent = '';
  
  if (APP.bookingStep === 1) {
    stepContent = `
      <h2 class="step-title">Select a Service</h2>
      <div class="public-service-grid">
        ${services.map(s => `
          <div class="public-service-card ${service?.id === s.id ? 'selected' : ''}" data-action="select-service" data-id="${s.id}">
            <span class="service-dot" style="background: ${s.color}"></span>
            <div style="flex: 1">
              <div style="font-weight: 600">${s.name}</div>
              <div style="font-size: 13px; color: #64748b">${s.duration_minutes} min</div>
            </div>
            <div style="font-weight: 600">${formatMoney(s.price)}</div>
          </div>
        `).join('')}
      </div>
      <button class="btn btn-primary" style="margin-top: 24px; width: 100%" ${!service ? 'disabled' : ''} data-action="booking-next">Continue</button>
    `;
  } else if (APP.bookingStep === 2) {
    stepContent = `
      <h2 class="step-title">Choose a Staff Member</h2>
      <div class="public-staff-grid">
        ${availableStaff.map(s => `
          <div class="public-staff-card ${selectedStaff?.id === s.id ? 'selected' : ''}" data-action="select-staff-booking" data-id="${s.id}">
            <div class="avatar-lg" style="background: ${s.color}; margin: 0 auto 8px">${s.full_name.charAt(0)}</div>
            <div style="font-weight: 600">${s.full_name}</div>
            <div style="font-size: 13px; color: #64748b">${s.title || ''}</div>
          </div>
        `).join('')}
      </div>
      <div style="display: flex; gap: 12px; margin-top: 24px">
        <button class="btn btn-secondary" data-action="booking-back">Back</button>
        <button class="btn btn-primary" style="flex: 1" ${!selectedStaff ? 'disabled' : ''} data-action="booking-next">Continue</button>
      </div>
    `;
  } else if (APP.bookingStep === 3) {
    stepContent = `
      <h2 class="step-title">Pick a Date & Time</h2>
      <div class="date-grid">
        ${dates.map(d => `
          <div class="date-card ${APP.bookingData.selectedDate?.toDateString() === d.toDateString() ? 'selected' : ''}" data-action="select-date" data-date="${d.toISOString()}">
            <div class="date-weekday">${d.toLocaleDateString('en-US', { weekday: 'short' })}</div>
            <div class="date-day">${d.getDate()}</div>
            <div class="date-month">${d.toLocaleDateString('en-US', { month: 'short' })}</div>
          </div>
        `).join('')}
      </div>
      ${APP.bookingData.selectedDate ? `
        <div style="margin-top: 24px">
          <h3 style="margin-bottom: 12px">Available Times</h3>
          ${availableSlots.length === 0 ? '<p style="color: #64748b">No available slots on this date</p>' : `
            <div class="time-grid">
              ${availableSlots.map(slot => `
                <div class="time-slot ${time === slot.time ? 'selected' : ''}" data-action="select-time" data-time="${slot.time}">${slot.display}</div>
              `).join('')}
            </div>
          `}
        </div>
      ` : ''}
      <div style="display: flex; gap: 12px; margin-top: 24px">
        <button class="btn btn-secondary" data-action="booking-back">Back</button>
        <button class="btn btn-primary" style="flex: 1" ${!time ? 'disabled' : ''} data-action="booking-next">Continue</button>
      </div>
    `;
  } else if (APP.bookingStep === 4) {
    stepContent = `
      <h2 class="step-title">Your Information</h2>
      <form id="booking-client-form">
        <div class="form-group">
          <label>Your Name</label>
          <input type="text" name="name" value="${client?.name || ''}" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" name="email" value="${client?.email || ''}" required>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" name="phone" value="${client?.phone || ''}">
        </div>
        <div class="form-group">
          <label>Notes (optional)</label>
          <textarea name="notes">${client?.notes || ''}</textarea>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 24px">
          <button type="button" class="btn btn-secondary" data-action="booking-back">Back</button>
          <button type="submit" class="btn btn-primary" style="flex: 1">Review Booking</button>
        </div>
      </form>
    `;
  } else if (APP.bookingStep === 5) {
    stepContent = `
      <h2 class="step-title">Confirm Your Booking</h2>
      <div class="booking-summary">
        <div class="summary-row">
          <span>Service</span>
          <strong>${service?.name}</strong>
        </div>
        <div class="summary-row">
          <span>Staff</span>
          <strong>${selectedStaff?.full_name}</strong>
        </div>
        <div class="summary-row">
          <span>Date</span>
          <strong>${date ? new Date(date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }) : ''}</strong>
        </div>
        <div class="summary-row">
          <span>Time</span>
          <strong>${time ? formatTimeStr(time) : ''}</strong>
        </div>
        <div class="summary-row">
          <span>Duration</span>
          <strong>${service?.duration_minutes} minutes</strong>
        </div>
        <div class="summary-row" style="border-top: 2px solid #e2e8f0; padding-top: 12px; margin-top: 12px">
          <span>Price</span>
          <strong style="font-size: 20px">${formatMoney(service?.price)}</strong>
        </div>
      </div>
      <div style="display: flex; gap: 12px; margin-top: 24px">
        <button class="btn btn-secondary" data-action="booking-back">Back</button>
        <button class="btn btn-primary" style="flex: 1" data-action="confirm-booking">Confirm Booking</button>
      </div>
    `;
  } else if (APP.bookingStep === 6) {
    stepContent = `
      <div style="text-align: center; padding: 40px 0">
        <div class="confirm-icon">‚úÖ</div>
        <h2>Booking Confirmed!</h2>
        <p style="color: #64748b">You'll receive a confirmation email shortly.</p>
        <div class="booking-summary" style="margin-top: 24px; text-align: left">
          <div class="summary-row">
            <span>Service</span>
            <strong>${service?.name}</strong>
          </div>
          <div class="summary-row">
            <span>With</span>
            <strong>${selectedStaff?.full_name}</strong>
          </div>
          <div class="summary-row">
            <span>Date & Time</span>
            <strong>${date ? new Date(date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) : ''} at ${time ? formatTimeStr(time) : ''}</strong>
          </div>
        </div>
        <button class="btn btn-secondary" style="margin-top: 24px" data-action="close-public">Close</button>
      </div>
    `;
  }
  
  return `
    <div class="public-wrap">
      <div class="public-card">
        <div class="public-header">
          <h1>${org.name}</h1>
          <p style="color: #64748b; margin: 4px 0 0">Online Booking</p>
        </div>
        
        <div class="progress-bar">
          ${['Service', 'Staff', 'Date & Time', 'Your Info', 'Confirm'].map((step, i) => `
            <div class="progress-step ${APP.bookingStep > i + 1 ? 'done' : ''} ${APP.bookingStep === i + 1 ? 'active' : ''}">
              <div class="progress-dot">${APP.bookingStep > i + 1 ? '‚úì' : i + 1}</div>
              <span>${step}</span>
            </div>
          `).join('')}
        </div>
        
        ${stepContent}
      </div>
      ${APP.toast ? `<div class="toast ${APP.toast.type === 'error' ? 'error' : ''}">${APP.toast.msg}</div>` : ''}
    </div>
  `;
}

// Event Listeners
function attachEventListeners() {
  // Navigation
  document.querySelectorAll('[data-view]').forEach(el => {
    el.addEventListener('click', () => {
      APP.currentView = el.dataset.view;
      render();
    });
  });
  
  // Actions
  document.querySelectorAll('[data-action]').forEach(el => {
    el.addEventListener('click', (e) => handleAction(el.dataset.action, el.dataset, e));
    el.addEventListener('change', (e) => handleAction(el.dataset.action, el.dataset, e));
  });
  
  // Forms
  const staffForm = document.getElementById('staff-form');
  if (staffForm) {
    staffForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const fd = new FormData(staffForm);
      saveStaff({
        full_name: fd.get('full_name'),
        email: fd.get('email'),
        phone: fd.get('phone'),
        title: fd.get('title'),
        color: fd.get('color'),
        role: fd.get('role'),
        is_active: fd.has('is_active'),
        accepts_bookings: fd.has('accepts_bookings')
      });
    });
  }
  
  const serviceForm = document.getElementById('service-form');
  if (serviceForm) {
    serviceForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const fd = new FormData(serviceForm);
      saveService({
        name: fd.get('name'),
        description: fd.get('description'),
        duration_minutes: parseInt(fd.get('duration_minutes')),
        price: parseFloat(fd.get('price')),
        color: fd.get('color'),
        category: fd.get('category'),
        is_active: fd.has('is_active')
      });
    });
  }
  
  const clientForm = document.getElementById('client-form');
  if (clientForm) {
    clientForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const fd = new FormData(clientForm);
      saveClient({
        full_name: fd.get('full_name'),
        email: fd.get('email'),
        phone: fd.get('phone'),
        notes: fd.get('notes')
      });
    });
  }
  
  const appointmentForm = document.getElementById('appointment-form');
  if (appointmentForm) {
    appointmentForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const fd = new FormData(appointmentForm);
      saveAppointment({
        client_id: fd.get('client_id'),
        service_id: fd.get('service_id'),
        user_id: fd.get('user_id'),
        date: fd.get('date'),
        time: fd.get('time'),
        status: fd.get('status'),
        notes: fd.get('notes')
      });
    });
  }
  
  const settingsForm = document.getElementById('settings-form');
  if (settingsForm) {
    settingsForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const fd = new FormData(settingsForm);
      saveSettings({
        name: fd.get('name'),
        email: fd.get('email'),
        phone: fd.get('phone'),
        timezone: fd.get('timezone'),
        buffer_minutes: parseInt(fd.get('buffer_minutes')),
        advance_notice_hours: parseInt(fd.get('advance_notice_hours')),
        max_advance_days: parseInt(fd.get('max_advance_days')),
        cancellation_hours: parseInt(fd.get('cancellation_hours')),
        allow_client_cancel: fd.has('allow_client_cancel')
      });
    });
  }
  
  const bookingClientForm = document.getElementById('booking-client-form');
  if (bookingClientForm) {
    bookingClientForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const fd = new FormData(bookingClientForm);
      APP.bookingData.client = {
        name: fd.get('name'),
        email: fd.get('email'),
        phone: fd.get('phone'),
        notes: fd.get('notes')
      };
      APP.bookingStep = 5;
      render();
    });
  }
  
  // Filters
  const staffFilter = document.getElementById('staff-filter');
  if (staffFilter) {
    staffFilter.addEventListener('change', () => {
      APP.selectedStaffId = staffFilter.value || null;
      render();
    });
  }
  
  const statusFilter = document.getElementById('status-filter');
  if (statusFilter) {
    statusFilter.addEventListener('change', () => {
      APP.filterStatus = statusFilter.value;
      render();
    });
  }
}

function handleAction(action, data, event) {
  const db = getData();
  
  switch (action) {
    case 'new-staff':
      APP.modal = 'staff';
      APP.editingItem = null;
      render();
      break;
      
    case 'edit-staff':
      APP.modal = 'staff';
      APP.editingItem = db.staff.find(s => s.id === data.id);
      render();
      break;
      
    case 'select-staff':
      APP.selectedStaffId = data.id;
      render();
      break;
      
    case 'new-service':
      APP.modal = 'service';
      APP.editingItem = null;
      render();
      break;
      
    case 'edit-service':
      APP.modal = 'service';
      APP.editingItem = db.services.find(s => s.id === data.id);
      render();
      break;
      
    case 'new-client':
      APP.modal = 'client';
      APP.editingItem = null;
      render();
      break;
      
    case 'edit-client':
      APP.modal = 'client';
      APP.editingItem = db.clients.find(c => c.id === data.id);
      render();
      break;
      
    case 'new-appointment':
      APP.modal = 'appointment';
      APP.editingItem = null;
      render();
      break;
      
    case 'edit-appt':
      APP.modal = 'appointment';
      APP.editingItem = db.appointments.find(a => a.id === data.id);
      render();
      break;
      
    case 'cancel-appt':
      cancelAppointment(data.id);
      break;
      
    case 'complete-appt':
      completeAppointment(data.id);
      break;
      
    case 'close-modal':
      APP.modal = null;
      APP.editingItem = null;
      render();
      break;
      
    case 'prev-week':
      APP.selectedDate.setDate(APP.selectedDate.getDate() - 7);
      render();
      break;
      
    case 'next-week':
      APP.selectedDate.setDate(APP.selectedDate.getDate() + 7);
      render();
      break;
      
    case 'toggle-avail':
      const currentAvail = db.availability.find(a => a.user_id === data.staff && a.day_of_week === parseInt(data.day));
      saveAvailability(data.staff, parseInt(data.day), currentAvail?.start_time || '09:00', currentAvail?.end_time || '17:00', event.target.checked);
      break;
      
    case 'set-avail-start':
      const availStart = db.availability.find(a => a.user_id === data.staff && a.day_of_week === parseInt(data.day));
      if (availStart) saveAvailability(data.staff, parseInt(data.day), event.target.value, availStart.end_time, true);
      break;
      
    case 'set-avail-end':
      const availEnd = db.availability.find(a => a.user_id === data.staff && a.day_of_week === parseInt(data.day));
      if (availEnd) saveAvailability(data.staff, parseInt(data.day), availEnd.start_time, event.target.value, true);
      break;
      
    case 'toggle-staff-service':
      toggleStaffService(data.staff, data.service, event.target.checked);
      break;
      
    case 'reset-data':
      if (confirm('Reset all demo data to defaults?')) {
        localStorage.removeItem('bookitpro_demo');
        location.reload();
      }
      break;
      
    case 'open-public':
      APP.publicMode = true;
      APP.bookingStep = 1;
      APP.bookingData = {};
      render();
      break;
      
    case 'close-public':
      APP.publicMode = false;
      APP.bookingStep = 1;
      APP.bookingData = {};
      render();
      break;
      
    case 'select-service':
      APP.bookingData.service = db.services.find(s => s.id === data.id);
      render();
      break;
      
    case 'select-staff-booking':
      APP.bookingData.staff = db.staff.find(s => s.id === data.id);
      render();
      break;
      
    case 'select-date':
      APP.bookingData.selectedDate = new Date(data.date);
      APP.bookingData.date = data.date.split('T')[0];
      APP.bookingData.time = null;
      render();
      break;
      
    case 'select-time':
      APP.bookingData.time = data.time;
      render();
      break;
      
    case 'booking-next':
      APP.bookingStep++;
      render();
      break;
      
    case 'booking-back':
      APP.bookingStep--;
      render();
      break;
      
    case 'confirm-booking':
      // Create the appointment
      const service = APP.bookingData.service;
      const selectedStaff = APP.bookingData.staff;
      const startTime = new Date(`${APP.bookingData.date}T${APP.bookingData.time}`);
      const endTime = new Date(startTime.getTime() + service.duration_minutes * 60000);
      
      // Find or create client
      let clientId;
      const existingClient = db.clients.find(c => c.email === APP.bookingData.client.email);
      if (existingClient) {
        clientId = existingClient.id;
      } else {
        clientId = generateId();
        db.clients.push({
          id: clientId,
          full_name: APP.bookingData.client.name,
          email: APP.bookingData.client.email,
          phone: APP.bookingData.client.phone || '',
          notes: ''
        });
      }
      
      db.appointments.push({
        id: generateId(),
        user_id: selectedStaff.id,
        client_id: clientId,
        service_id: service.id,
        start_time: startTime.toISOString(),
        end_time: endTime.toISOString(),
        status: 'confirmed',
        notes: APP.bookingData.client.notes || ''
      });
      
      saveData(db);
      APP.bookingStep = 6;
      showToast('Appointment booked!');
      render();
      break;
  }
}

// Check for public booking URL
function checkPublicMode() {
  const params = new URLSearchParams(window.location.search);
  if (params.get('book')) {
    APP.publicMode = true;
  }
}

// Initialize
checkPublicMode();
render();
</script>
</body>
</html>
