<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MaintenancePro Plus - Demo</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f8fafc; min-height: 100vh; }
    .app { display: flex; min-height: 100vh; }
    .sidebar { width: 200px; background: #1e293b; padding: 16px; position: fixed; height: calc(100vh - 36px); top: 36px; display: flex; flex-direction: column; }
    .logo { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
    .logo-icon { font-size: 24px; }
    .logo-text { font-weight: 700; font-size: 15px; color: #fff; }
    .org-info { padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 16px; }
    .org-name { font-weight: 600; font-size: 13px; color: #fff; }
    .user-name { font-size: 11px; color: #94a3b8; }
    .nav-item { display: flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 8px; cursor: pointer; color: #94a3b8; font-size: 13px; margin-bottom: 2px; }
    .nav-item:hover { background: rgba(255,255,255,0.1); }
    .nav-item.active { background: rgba(59,130,246,0.2); color: #fff; font-weight: 500; }
    .nav-badge { background: #ef4444; color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: auto; }
    .main { flex: 1; margin-left: 200px; padding: 24px; margin-top: 36px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .title { font-size: 24px; font-weight: 700; }
    .btn { padding: 10px 18px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 14px; }
    .btn-primary { background: #3b82f6; color: #fff; }
    .btn-success { background: #22c55e; color: #fff; }
    .btn-secondary { background: #fff; border: 1px solid #e2e8f0; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: #fff; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; }
    .stat-label { font-size: 12px; color: #64748b; margin-bottom: 4px; }
    .stat-value { font-size: 28px; font-weight: 700; }
    .card { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; padding: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 11px; text-transform: uppercase; color: #64748b; }
    td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; }
    .priority-low { background: #94a3b8; color: #fff; }
    .priority-medium { background: #3b82f6; color: #fff; }
    .priority-high { background: #f59e0b; color: #fff; }
    .priority-urgent { background: #ef4444; color: #fff; }
    .status-new { background: #fef3c7; color: #92400e; }
    .status-approved, .status-open { background: #dbeafe; color: #1e40af; }
    .status-in_progress { background: #e0e7ff; color: #4338ca; }
    .status-completed { background: #dcfce7; color: #166534; }
    .status-cancelled, .status-on_hold { background: #f1f5f9; color: #64748b; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; }
    .modal { background: #fff; border-radius: 16px; padding: 24px; width: 100%; max-width: 550px; max-height: 90vh; overflow-y: auto; }
    .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; }
    .modal-actions { display: flex; gap: 12px; margin-top: 20px; justify-content: flex-end; }
    .field { margin-bottom: 16px; }
    .field label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; }
    .field input, .field select, .field textarea { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 14px; font-family: inherit; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .hidden { display: none !important; }
    .demo-banner { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: #fff; padding: 8px 16px; text-align: center; font-size: 13px; position: fixed; top: 0; left: 0; right: 0; z-index: 300; }
    .demo-banner a { color: #fff; font-weight: 600; }
    .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: #fff; padding: 12px 20px; border-radius: 8px; z-index: 200; }
    .overdue { background: #fef2f2; }
  </style>
</head>
<body>
  <div class="demo-banner">üîß MaintenancePro Plus Demo - Data stored in browser | <a href="https://buyappsonce.com/landing-maintenancepro-plus.html">Get MaintenancePro Plus - $99 ‚Üí</a></div>
  <div class="app">
    <nav class="sidebar">
      <div class="logo"><span class="logo-icon">üîß</span><span class="logo-text">MaintenancePro</span></div>
      <div class="org-info"><div class="org-name">Demo Property</div><div class="user-name">Admin User</div></div>
      <div class="nav-item active" onclick="showTab('dashboard')">üìä Dashboard</div>
      <div class="nav-item" onclick="showTab('requests')" id="navRequests">üìù Requests</div>
      <div class="nav-item" onclick="showTab('workorders')" id="navWO">üîß Work Orders</div>
      <div class="nav-item" onclick="showTab('locations')">üìç Locations</div>
      <div class="nav-item" onclick="showTab('assets')">‚öôÔ∏è Assets</div>
      <div class="nav-item" onclick="showTab('pm')" id="navPM">üìÖ PM Schedules</div>
      <div class="nav-item" onclick="showTab('reports')">üìà Reports</div>
      <div class="nav-item" onclick="showTab('activity')">üìú Activity Log</div>
      <div class="nav-item" onclick="showTab('track')">üîç Track Status</div>
    </nav>
    <main class="main" id="mainContent"></main>
  </div>
  <div class="overlay hidden" id="modal" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-head"><h2 id="modalTitle">Modal</h2><button class="close-btn" onclick="closeModal()">√ó</button></div>
      <div id="modalContent"></div>
    </div>
  </div>
  <div class="toast hidden" id="toast"></div>

<script>
const CATEGORIES = ['Plumbing', 'Electrical', 'HVAC', 'Appliances', 'Structural', 'Grounds', 'Safety', 'Other'];
const PRIORITIES = ['low', 'medium', 'high', 'urgent'];

let state = { tab: 'dashboard', requests: [], workOrders: [], locations: [], assets: [], pmSchedules: [], auditLog: [], editing: null, trackingCode: '', trackingResult: null };

function init() {
  loadData();
  if (state.locations.length === 0) loadSampleData();
  render();
}

function loadData() {
  state.requests = JSON.parse(localStorage.getItem('mp_requests') || '[]');
  state.workOrders = JSON.parse(localStorage.getItem('mp_workorders') || '[]');
  state.locations = JSON.parse(localStorage.getItem('mp_locations') || '[]');
  state.assets = JSON.parse(localStorage.getItem('mp_assets') || '[]');
  state.pmSchedules = JSON.parse(localStorage.getItem('mp_pm') || '[]');
  state.auditLog = JSON.parse(localStorage.getItem('mp_audit') || '[]');
}

function saveData() {
  localStorage.setItem('mp_requests', JSON.stringify(state.requests));
  localStorage.setItem('mp_workorders', JSON.stringify(state.workOrders));
  localStorage.setItem('mp_locations', JSON.stringify(state.locations));
  localStorage.setItem('mp_assets', JSON.stringify(state.assets));
  localStorage.setItem('mp_pm', JSON.stringify(state.pmSchedules));
  localStorage.setItem('mp_audit', JSON.stringify(state.auditLog));
}

function loadSampleData() {
  const today = new Date().toISOString().split('T')[0];
  const lastWeek = new Date(Date.now() - 7*86400000).toISOString().split('T')[0];
  const nextWeek = new Date(Date.now() + 7*86400000).toISOString().split('T')[0];
  
  state.locations = [
    { id: 1, name: 'Building A - Lobby', building: 'Building A', unit: 'Lobby' },
    { id: 2, name: 'Building A - Unit 101', building: 'Building A', unit: '101' },
    { id: 3, name: 'Building B - Unit 201', building: 'Building B', unit: '201' },
    { id: 4, name: 'Parking Garage', building: 'Exterior', unit: '' }
  ];
  state.assets = [
    { id: 1, name: 'Lobby HVAC Unit', category: 'HVAC', location_id: 1, make: 'Carrier', model: 'XR15' },
    { id: 2, name: 'Elevator #1', category: 'Other', location_id: 1, make: 'Otis', model: 'Gen2' },
    { id: 3, name: 'Unit 101 Water Heater', category: 'Plumbing', location_id: 2, make: 'Rheem', model: '40G' },
    { id: 4, name: 'Garage Lighting', category: 'Electrical', location_id: 4, make: 'GE', model: 'LED-400' }
  ];
  state.requests = [
    { id: 1, title: 'Leaking faucet in bathroom', location_id: 2, category: 'Plumbing', priority: 'medium', status: 'new', submitted_at: today, requester: 'John Tenant', tracking_code: 'REQ-A1B2C3D4' },
    { id: 2, title: 'AC not cooling properly', location_id: 3, asset_id: null, category: 'HVAC', priority: 'high', status: 'approved', submitted_at: lastWeek, requester: 'Jane Resident', tracking_code: 'REQ-E5F6G7H8' },
    { id: 3, title: 'Light flickering in hallway', location_id: 1, category: 'Electrical', priority: 'low', status: 'new', submitted_at: today, requester: 'Building Staff', tracking_code: 'REQ-I9J0K1L2' }
  ];
  state.workOrders = [
    { id: 1001, title: 'AC not cooling properly', location_id: 3, category: 'HVAC', priority: 'high', status: 'in_progress', assigned_to: 'Mike Tech', due_date: today, labor_hours: 2, labor_cost: 150, parts_cost: 75, total_cost: 225 },
    { id: 1002, title: 'Quarterly HVAC inspection', location_id: 1, asset_id: 1, category: 'HVAC', priority: 'medium', status: 'completed', assigned_to: 'Mike Tech', completed_at: lastWeek, labor_hours: 1.5, labor_cost: 112.50, parts_cost: 25, total_cost: 137.50 },
    { id: 1003, title: 'Replace parking lot lights', location_id: 4, asset_id: 4, category: 'Electrical', priority: 'medium', status: 'open', assigned_to: '', due_date: nextWeek, labor_cost: 0, parts_cost: 0, total_cost: 0 }
  ];
  state.pmSchedules = [
    { id: 1, title: 'HVAC Filter Change', asset_id: 1, location_id: 1, category: 'HVAC', frequency: 'monthly', last_completed: lastWeek, next_due: nextWeek, assigned_to: 'Mike Tech' },
    { id: 2, title: 'Elevator Inspection', asset_id: 2, location_id: 1, category: 'Other', frequency: 'quarterly', last_completed: null, next_due: today, assigned_to: 'External Vendor' },
    { id: 3, title: 'Fire Extinguisher Check', asset_id: null, location_id: null, category: 'Safety', frequency: 'yearly', last_completed: null, next_due: nextWeek, assigned_to: '' }
  ];
  saveData();
}

function showTab(tab) { state.tab = tab; updateNav(); render(); }
function updateNav() { document.querySelectorAll('.nav-item').forEach((n, i) => n.classList.toggle('active', i === ['dashboard', 'requests', 'workorders', 'locations', 'assets', 'pm', 'reports', 'activity', 'track'].indexOf(state.tab))); updateBadges(); }
function updateBadges() {
  const newReqs = state.requests.filter(r => r.status === 'new').length;
  const openWOs = state.workOrders.filter(w => !['completed','cancelled'].includes(w.status)).length;
  const pmDue = state.pmSchedules.filter(p => p.next_due <= new Date().toISOString().split('T')[0]).length;
  document.getElementById('navRequests').innerHTML = `üìù Requests ${newReqs > 0 ? `<span class="nav-badge">${newReqs}</span>` : ''}`;
  document.getElementById('navWO').innerHTML = `üîß Work Orders ${openWOs > 0 ? `<span class="nav-badge">${openWOs}</span>` : ''}`;
  document.getElementById('navPM').innerHTML = `üìÖ PM Schedules ${pmDue > 0 ? `<span class="nav-badge">${pmDue}</span>` : ''}`;
}

function getLocation(id) { return state.locations.find(l => l.id === id); }
function getAsset(id) { return state.assets.find(a => a.id === id); }
function fmt(n) { return '$' + (n || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
function fmtDate(d) { return d ? new Date(d + 'T12:00:00').toLocaleDateString() : '-'; }
function today() { return new Date().toISOString().split('T')[0]; }

function genTrackingCode() { return 'REQ-' + Math.random().toString(36).substring(2, 10).toUpperCase(); }

function logAudit(entityType, entityId, action, oldVal, newVal) {
  state.auditLog.unshift({ id: Date.now(), entity_type: entityType, entity_id: entityId, action, old_value: oldVal, new_value: newVal, changed_by_name: 'Admin User', created_at: new Date().toISOString() });
  if (state.auditLog.length > 100) state.auditLog = state.auditLog.slice(0, 100);
  saveData();
}

function lookupTracking() {
  const code = state.trackingCode.trim().toUpperCase();
  if (!code) return;
  const req = state.requests.find(r => r.tracking_code === code);
  state.trackingResult = req ? { tracking_code: code, request: req } : { error: true };
  render();
}

function importFromRentRoll() {
  const rentrollData = localStorage.getItem('maintenance_requests');
  if (rentrollData) {
    try {
      const imports = JSON.parse(rentrollData);
      imports.forEach(item => {
        const req = { id: state.requests.length + 1, title: item.title || 'Maintenance Request', description: item.description, location_id: null, category: item.category || 'Other', priority: item.priority || 'medium', status: 'new', submitted_at: today(), requester: item.tenant_name || 'RentRoll Import', tracking_code: genTrackingCode(), rentroll: { property: item.property_name, unit: item.unit_number, tenant: item.tenant_name, phone: item.tenant_phone, email: item.tenant_email } };
        state.requests.unshift(req);
        logAudit('request', req.id, 'created', null, { title: req.title, source: 'RentRoll' });
      });
      localStorage.removeItem('maintenance_requests');
      saveData(); render(); toast('Imported ' + imports.length + ' requests from RentRoll');
    } catch (e) { toast('Failed to import'); }
  } else {
    toast('No RentRoll data found');
  }
}

function render() {
  const main = document.getElementById('mainContent');
  const newReqs = state.requests.filter(r => r.status === 'new').length;
  const openWOs = state.workOrders.filter(w => !['completed','cancelled'].includes(w.status)).length;
  const pmDue = state.pmSchedules.filter(p => p.next_due <= today()).length;

  switch (state.tab) {
    case 'dashboard':
      main.innerHTML = `
        <div class="header"><h1 class="title">Dashboard</h1><button class="btn btn-primary" onclick="openRequestModal()">+ New Request</button></div>
        <div class="stats">
          <div class="stat-card"><div class="stat-label">New Requests</div><div class="stat-value" style="color:#f59e0b">${newReqs}</div></div>
          <div class="stat-card"><div class="stat-label">Open Work Orders</div><div class="stat-value" style="color:#3b82f6">${openWOs}</div></div>
          <div class="stat-card"><div class="stat-label">PM Due</div><div class="stat-value" style="color:${pmDue > 0 ? '#ef4444' : '#22c55e'}">${pmDue}</div></div>
          <div class="stat-card"><div class="stat-label">Completed (All Time)</div><div class="stat-value" style="color:#22c55e">${state.workOrders.filter(w => w.status === 'completed').length}</div></div>
        </div>
        <div class="grid-2">
          <div class="card"><h3 style="margin-bottom:16px">Recent Requests</h3>
            ${state.requests.slice(0, 5).map(r => `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e2e8f0"><div><div>${r.title}</div><div style="font-size:12px;color:#64748b">${r.requester}</div></div><span class="badge status-${r.status}">${r.status}</span></div>`).join('') || '<p style="color:#64748b">No requests</p>'}
          </div>
          <div class="card"><h3 style="margin-bottom:16px">PM Due Soon</h3>
            ${state.pmSchedules.filter(p => p.next_due <= new Date(Date.now() + 7*86400000).toISOString().split('T')[0]).map(p => `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #e2e8f0"><div><div>${p.title}</div><div style="font-size:12px;color:#64748b">${getAsset(p.asset_id)?.name || getLocation(p.location_id)?.name || ''}</div></div><div style="text-align:right"><div style="font-size:12px;color:${p.next_due <= today() ? '#ef4444' : '#64748b'}">${fmtDate(p.next_due)}</div><button class="btn btn-sm btn-success" onclick="completePM(${p.id})">Complete</button></div></div>`).join('') || '<p style="color:#64748b">No PM due</p>'}
          </div>
        </div>
      `;
      break;

    case 'requests':
      main.innerHTML = `
        <div class="header"><h1 class="title">Maintenance Requests</h1><div style="display:flex;gap:12px"><button class="btn btn-secondary" onclick="importFromRentRoll()">üì• Import RentRoll</button><button class="btn btn-primary" onclick="openRequestModal()">+ New Request</button></div></div>
        <div class="card">
          <table><thead><tr><th>ID</th><th>Tracking</th><th>Title</th><th>Location</th><th>Category</th><th>Priority</th><th>Status</th><th>Submitted</th><th>Actions</th></tr></thead>
          <tbody>${state.requests.map(r => `
            <tr><td>#${r.id}</td><td style="font-family:monospace;font-size:11px">${r.tracking_code || '-'}</td><td><strong>${r.title}</strong></td><td>${getLocation(r.location_id)?.name || '-'}</td><td>${r.category}</td><td><span class="badge priority-${r.priority}">${r.priority}</span></td><td><span class="badge status-${r.status}">${r.status}</span></td><td>${fmtDate(r.submitted_at)}</td><td>${r.status === 'new' ? `<button class="btn btn-sm btn-success" onclick="approveRequest(${r.id})">Approve</button>` : ''}</td></tr>
          `).join('')}</tbody></table>
        </div>
      `;
      break;

    case 'workorders':
      main.innerHTML = `
        <div class="header"><h1 class="title">Work Orders</h1><button class="btn btn-primary" onclick="openWOModal()">+ New Work Order</button></div>
        <div class="card">
          <table><thead><tr><th>WO#</th><th>Title</th><th>Location</th><th>Assigned</th><th>Priority</th><th>Status</th><th>Due</th><th>Cost</th><th></th></tr></thead>
          <tbody>${state.workOrders.map(w => `
            <tr><td>#${w.id}</td><td><strong>${w.title}</strong></td><td>${getLocation(w.location_id)?.name || '-'}</td><td>${w.assigned_to || '-'}</td><td><span class="badge priority-${w.priority}">${w.priority}</span></td><td><span class="badge status-${w.status}">${w.status.replace('_', ' ')}</span></td><td>${fmtDate(w.due_date)}</td><td>${fmt(w.total_cost)}</td><td><button class="btn btn-sm btn-secondary" onclick="editWO(${w.id})">Edit</button></td></tr>
          `).join('')}</tbody></table>
        </div>
      `;
      break;

    case 'locations':
      main.innerHTML = `
        <div class="header"><h1 class="title">Locations</h1><button class="btn btn-primary" onclick="openLocationModal()">+ Add Location</button></div>
        <div class="grid">${state.locations.map(l => `
          <div class="card" onclick="editLocation(${l.id})"><h3>${l.name}</h3>${l.building ? `<p style="color:#64748b;font-size:13px">Building: ${l.building}</p>` : ''}${l.unit ? `<p style="color:#64748b;font-size:13px">Unit: ${l.unit}</p>` : ''}</div>
        `).join('')}</div>
      `;
      break;

    case 'assets':
      main.innerHTML = `
        <div class="header"><h1 class="title">Assets</h1><button class="btn btn-primary" onclick="openAssetModal()">+ Add Asset</button></div>
        <div class="grid">${state.assets.map(a => `
          <div class="card" onclick="editAsset(${a.id})"><span class="badge" style="background:#e0e7ff;color:#4338ca">${a.category}</span><h3 style="margin-top:8px">${a.name}</h3><p style="color:#64748b;font-size:13px">${a.make} ${a.model}</p><p style="color:#64748b;font-size:12px">${getLocation(a.location_id)?.name || ''}</p></div>
        `).join('')}</div>
      `;
      break;

    case 'pm':
      main.innerHTML = `
        <div class="header"><h1 class="title">PM Schedules</h1><button class="btn btn-primary" onclick="openPMModal()">+ Add Schedule</button></div>
        <div class="card">
          <table><thead><tr><th>Task</th><th>Asset/Location</th><th>Frequency</th><th>Assigned</th><th>Last Done</th><th>Next Due</th><th></th></tr></thead>
          <tbody>${state.pmSchedules.map(p => `
            <tr class="${p.next_due <= today() ? 'overdue' : ''}"><td><strong>${p.title}</strong></td><td>${getAsset(p.asset_id)?.name || getLocation(p.location_id)?.name || '-'}</td><td>${p.frequency}</td><td>${p.assigned_to || '-'}</td><td>${fmtDate(p.last_completed)}</td><td style="color:${p.next_due <= today() ? '#ef4444' : ''}">${fmtDate(p.next_due)}</td><td><button class="btn btn-sm btn-success" onclick="completePM(${p.id})" style="margin-right:8px">Complete</button><button class="btn btn-sm btn-secondary" onclick="editPM(${p.id})">Edit</button></td></tr>
          `).join('')}</tbody></table>
        </div>
      `;
      break;

    case 'reports':
      const totalLabor = state.workOrders.reduce((s, w) => s + (w.labor_cost || 0), 0);
      const totalParts = state.workOrders.reduce((s, w) => s + (w.parts_cost || 0), 0);
      const maxCatCount = Math.max(...CATEGORIES.map(c => state.workOrders.filter(w => w.category === c).length), 1);
      main.innerHTML = `
        <div class="header"><h1 class="title">Reports</h1></div>
        <div class="card" style="margin-bottom:20px"><h3 style="margin-bottom:16px">Work Orders by Category</h3>
          <div style="display:flex;align-items:flex-end;gap:8px;height:150px">
            ${CATEGORIES.map(cat => { const count = state.workOrders.filter(w => w.category === cat).length; return `<div style="flex:1;text-align:center"><div style="background:#3b82f6;height:${(count/maxCatCount)*120}px;border-radius:4px 4px 0 0;min-height:${count>0?20:0}px"></div><div style="font-size:10px;color:#64748b;margin-top:4px">${cat.slice(0,4)}</div><div style="font-size:12px;font-weight:600">${count}</div></div>`; }).join('')}
          </div>
        </div>
        <div class="card" style="margin-bottom:20px"><h3 style="margin-bottom:16px">Status Breakdown</h3>
          <div style="display:flex;gap:8px">
            ${['open', 'in_progress', 'completed'].map(status => { const count = state.workOrders.filter(w => w.status === status).length; const total = state.workOrders.length || 1; const pct = Math.round((count/total)*100); const colors = { open: '#f59e0b', in_progress: '#3b82f6', completed: '#22c55e' }; return `<div style="flex:1;text-align:center;padding:16px;background:#f8fafc;border-radius:8px"><div style="font-size:28px;font-weight:700;color:${colors[status]}">${pct}%</div><div style="font-size:12px;color:#64748b">${status.replace('_', ' ')}</div><div style="font-size:11px">${count} WOs</div></div>`; }).join('')}
          </div>
        </div>
        <div class="grid-2">
          <div class="card"><h3 style="margin-bottom:16px">Work Order Summary</h3>
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e2e8f0"><span>Open</span><strong>${state.workOrders.filter(w => w.status === 'open').length}</strong></div>
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e2e8f0"><span>In Progress</span><strong>${state.workOrders.filter(w => w.status === 'in_progress').length}</strong></div>
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e2e8f0"><span>Completed</span><strong style="color:#22c55e">${state.workOrders.filter(w => w.status === 'completed').length}</strong></div>
          </div>
          <div class="card"><h3 style="margin-bottom:16px">Costs (All Time)</h3>
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e2e8f0"><span>Labor</span><strong>${fmt(totalLabor)}</strong></div>
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e2e8f0"><span>Parts</span><strong>${fmt(totalParts)}</strong></div>
            <div style="display:flex;justify-content:space-between;padding:12px 0;font-weight:700"><span>Total</span><span>${fmt(totalLabor + totalParts)}</span></div>
          </div>
        </div>
      `;
      break;

    case 'activity':
      main.innerHTML = `
        <div class="header"><h1 class="title">Activity Log</h1></div>
        <div class="card">
          <table><thead><tr><th>Time</th><th>User</th><th>Type</th><th>ID</th><th>Action</th><th>Details</th></tr></thead>
          <tbody>${state.auditLog.slice(0, 50).map(log => `
            <tr><td>${new Date(log.created_at).toLocaleString()}</td><td>${log.changed_by_name || '-'}</td><td><span class="badge" style="background:#e0e7ff;color:#4338ca">${log.entity_type}</span></td><td>#${log.entity_id}</td><td><span class="badge status-${log.action}">${log.action}</span></td><td style="font-size:12px;color:#64748b">${log.new_value ? JSON.stringify(log.new_value).slice(0, 40) + '...' : '-'}</td></tr>
          `).join('') || '<tr><td colspan="6" style="text-align:center;padding:20px;color:#64748b">No activity yet</td></tr>'}</tbody></table>
        </div>
      `;
      break;

    case 'track':
      main.innerHTML = `
        <div class="header"><h1 class="title">Track Request Status</h1></div>
        <div class="card" style="max-width:500px">
          <p style="margin-bottom:16px;color:#64748b">Enter your tracking code to check the status of your maintenance request.</p>
          <div style="display:flex;gap:12px">
            <input style="flex:1;padding:10px 12px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px" placeholder="e.g., REQ-A1B2C3D4" value="${state.trackingCode}" oninput="state.trackingCode=this.value.toUpperCase()">
            <button class="btn btn-primary" onclick="lookupTracking()">Track</button>
          </div>
          ${state.trackingResult && !state.trackingResult.error ? `
            <div style="margin-top:24px;padding:20px;background:#f8fafc;border-radius:12px">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3>${state.trackingResult.request.title}</h3><span class="badge status-${state.trackingResult.request.status}">${state.trackingResult.request.status}</span></div>
              <div style="font-size:14px;color:#64748b">
                <p><strong>Tracking Code:</strong> ${state.trackingResult.tracking_code}</p>
                <p><strong>Category:</strong> ${state.trackingResult.request.category}</p>
                <p><strong>Location:</strong> ${getLocation(state.trackingResult.request.location_id)?.name || 'N/A'}</p>
                <p><strong>Submitted:</strong> ${fmtDate(state.trackingResult.request.submitted_at)}</p>
                <p><strong>Priority:</strong> <span class="badge priority-${state.trackingResult.request.priority}">${state.trackingResult.request.priority}</span></p>
              </div>
            </div>
          ` : ''}
          ${state.trackingResult?.error ? `<div style="margin-top:16px;padding:16px;background:#fef2f2;border-radius:8px;color:#dc2626">Tracking code not found. Please check and try again.</div>` : ''}
        </div>
      `;
      break;
  }
  updateBadges();
}

function openModal(title, content) { document.getElementById('modalTitle').textContent = title; document.getElementById('modalContent').innerHTML = content; document.getElementById('modal').classList.remove('hidden'); }
function closeModal() { document.getElementById('modal').classList.add('hidden'); state.editing = null; }

function openRequestModal() {
  openModal('New Maintenance Request', `
    <form onsubmit="saveRequest(event)">
      <div class="field"><label>Title</label><input name="title" required placeholder="Brief description of issue"></div>
      <div class="row"><div class="field"><label>Category</label><select name="category">${CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('')}</select></div><div class="field"><label>Priority</label><select name="priority">${PRIORITIES.map(p => `<option value="${p}" ${p === 'medium' ? 'selected' : ''}>${p.charAt(0).toUpperCase() + p.slice(1)}</option>`).join('')}</select></div></div>
      <div class="field"><label>Location</label><select name="location_id"><option value="">Select...</option>${state.locations.map(l => `<option value="${l.id}">${l.name}</option>`).join('')}</select></div>
      <div class="field"><label>Description</label><textarea name="description" placeholder="Detailed description..."></textarea></div>
      <div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="submit" class="btn btn-primary">Submit</button></div>
    </form>
  `);
}
function saveRequest(e) {
  e.preventDefault(); const f = e.target;
  const req = { id: state.requests.length + 1, title: f.title.value, location_id: f.location_id.value ? parseInt(f.location_id.value) : null, category: f.category.value, priority: f.priority.value, status: 'new', submitted_at: today(), requester: 'Demo User', description: f.description.value, tracking_code: genTrackingCode() };
  state.requests.unshift(req);
  logAudit('request', req.id, 'created', null, { title: req.title });
  saveData(); closeModal(); render(); toast('Request submitted - Tracking: ' + req.tracking_code);
}

function approveRequest(id) {
  const req = state.requests.find(r => r.id === id);
  if (!req) return;
  req.status = 'approved';
  logAudit('request', id, 'status_changed', { status: 'new' }, { status: 'approved' });
  const woId = 1000 + state.workOrders.length + 1;
  state.workOrders.unshift({ id: woId, title: req.title, location_id: req.location_id, category: req.category, priority: req.priority, status: 'open', assigned_to: '', due_date: '', labor_hours: 0, labor_cost: 0, parts_cost: 0, total_cost: 0 });
  logAudit('work_order', woId, 'created', null, { title: req.title, from_request: id });
  saveData(); render(); toast(`Approved - Work Order #${woId} created`);
}

function openWOModal(wo) {
  state.editing = wo;
  openModal(wo ? `Work Order #${wo.id}` : 'New Work Order', `
    <form onsubmit="saveWO(event)">
      <div class="field"><label>Title</label><input name="title" value="${wo?.title || ''}" required></div>
      <div class="row"><div class="field"><label>Category</label><select name="category">${CATEGORIES.map(c => `<option value="${c}" ${wo?.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div><div class="field"><label>Priority</label><select name="priority">${PRIORITIES.map(p => `<option value="${p}" ${wo?.priority === p ? 'selected' : ''}>${p.charAt(0).toUpperCase() + p.slice(1)}</option>`).join('')}</select></div></div>
      <div class="row"><div class="field"><label>Status</label><select name="status"><option value="open" ${wo?.status === 'open' ? 'selected' : ''}>Open</option><option value="in_progress" ${wo?.status === 'in_progress' ? 'selected' : ''}>In Progress</option><option value="on_hold" ${wo?.status === 'on_hold' ? 'selected' : ''}>On Hold</option><option value="completed" ${wo?.status === 'completed' ? 'selected' : ''}>Completed</option></select></div><div class="field"><label>Assigned To</label><input name="assigned_to" value="${wo?.assigned_to || ''}"></div></div>
      <div class="row"><div class="field"><label>Location</label><select name="location_id"><option value="">None</option>${state.locations.map(l => `<option value="${l.id}" ${wo?.location_id === l.id ? 'selected' : ''}>${l.name}</option>`).join('')}</select></div><div class="field"><label>Due Date</label><input type="date" name="due_date" value="${wo?.due_date || ''}"></div></div>
      <div class="row"><div class="field"><label>Labor Hours</label><input type="number" step="0.25" name="labor_hours" value="${wo?.labor_hours || ''}"></div><div class="field"><label>Labor Cost</label><input type="number" step="0.01" name="labor_cost" value="${wo?.labor_cost || ''}"></div></div>
      <div class="field"><label>Parts Cost</label><input type="number" step="0.01" name="parts_cost" value="${wo?.parts_cost || ''}"></div>
      <div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  `);
}
function editWO(id) { openWOModal(state.workOrders.find(w => w.id === id)); }
function saveWO(e) {
  e.preventDefault(); const f = e.target;
  const laborCost = parseFloat(f.labor_cost.value) || 0;
  const partsCost = parseFloat(f.parts_cost.value) || 0;
  const data = { title: f.title.value, category: f.category.value, priority: f.priority.value, status: f.status.value, assigned_to: f.assigned_to.value, location_id: f.location_id.value ? parseInt(f.location_id.value) : null, due_date: f.due_date.value, labor_hours: parseFloat(f.labor_hours.value) || 0, labor_cost: laborCost, parts_cost: partsCost, total_cost: laborCost + partsCost };
  if (f.status.value === 'completed' && !state.editing?.completed_at) data.completed_at = today();
  if (state.editing) {
    const oldStatus = state.editing.status;
    Object.assign(state.editing, data);
    if (oldStatus !== f.status.value) logAudit('work_order', state.editing.id, 'status_changed', { status: oldStatus }, { status: f.status.value });
    else logAudit('work_order', state.editing.id, 'updated', null, data);
  }
  else { data.id = 1000 + state.workOrders.length + 1; state.workOrders.unshift(data); logAudit('work_order', data.id, 'created', null, data); }
  saveData(); closeModal(); render(); toast('Work order saved');
}

function openLocationModal(loc) {
  state.editing = loc;
  openModal(loc ? 'Edit Location' : 'Add Location', `
    <form onsubmit="saveLocation(event)">
      <div class="field"><label>Name</label><input name="name" value="${loc?.name || ''}" required></div>
      <div class="row"><div class="field"><label>Building</label><input name="building" value="${loc?.building || ''}"></div><div class="field"><label>Unit</label><input name="unit" value="${loc?.unit || ''}"></div></div>
      <div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  `);
}
function editLocation(id) { openLocationModal(state.locations.find(l => l.id === id)); }
function saveLocation(e) {
  e.preventDefault(); const f = e.target;
  if (state.editing) { Object.assign(state.editing, { name: f.name.value, building: f.building.value, unit: f.unit.value }); }
  else { state.locations.push({ id: Date.now(), name: f.name.value, building: f.building.value, unit: f.unit.value }); }
  saveData(); closeModal(); render(); toast('Location saved');
}

function openAssetModal(asset) {
  state.editing = asset;
  openModal(asset ? 'Edit Asset' : 'Add Asset', `
    <form onsubmit="saveAsset(event)">
      <div class="field"><label>Name</label><input name="name" value="${asset?.name || ''}" required></div>
      <div class="row"><div class="field"><label>Category</label><select name="category">${CATEGORIES.map(c => `<option value="${c}" ${asset?.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div><div class="field"><label>Location</label><select name="location_id"><option value="">None</option>${state.locations.map(l => `<option value="${l.id}" ${asset?.location_id === l.id ? 'selected' : ''}>${l.name}</option>`).join('')}</select></div></div>
      <div class="row"><div class="field"><label>Make</label><input name="make" value="${asset?.make || ''}"></div><div class="field"><label>Model</label><input name="model" value="${asset?.model || ''}"></div></div>
      <div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  `);
}
function editAsset(id) { openAssetModal(state.assets.find(a => a.id === id)); }
function saveAsset(e) {
  e.preventDefault(); const f = e.target;
  const data = { name: f.name.value, category: f.category.value, location_id: f.location_id.value ? parseInt(f.location_id.value) : null, make: f.make.value, model: f.model.value };
  if (state.editing) { Object.assign(state.editing, data); }
  else { data.id = Date.now(); state.assets.push(data); }
  saveData(); closeModal(); render(); toast('Asset saved');
}

function openPMModal(pm) {
  state.editing = pm;
  openModal(pm ? 'Edit PM Schedule' : 'Add PM Schedule', `
    <form onsubmit="savePM(event)">
      <div class="field"><label>Title</label><input name="title" value="${pm?.title || ''}" required placeholder="e.g., HVAC Filter Change"></div>
      <div class="row"><div class="field"><label>Category</label><select name="category">${CATEGORIES.map(c => `<option value="${c}" ${pm?.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div><div class="field"><label>Frequency</label><select name="frequency"><option value="daily" ${pm?.frequency === 'daily' ? 'selected' : ''}>Daily</option><option value="weekly" ${pm?.frequency === 'weekly' ? 'selected' : ''}>Weekly</option><option value="monthly" ${pm?.frequency === 'monthly' ? 'selected' : ''}>Monthly</option><option value="quarterly" ${pm?.frequency === 'quarterly' ? 'selected' : ''}>Quarterly</option><option value="yearly" ${pm?.frequency === 'yearly' ? 'selected' : ''}>Yearly</option></select></div></div>
      <div class="row"><div class="field"><label>Asset</label><select name="asset_id"><option value="">None</option>${state.assets.map(a => `<option value="${a.id}" ${pm?.asset_id === a.id ? 'selected' : ''}>${a.name}</option>`).join('')}</select></div><div class="field"><label>Location</label><select name="location_id"><option value="">None</option>${state.locations.map(l => `<option value="${l.id}" ${pm?.location_id === l.id ? 'selected' : ''}>${l.name}</option>`).join('')}</select></div></div>
      <div class="row"><div class="field"><label>Assigned To</label><input name="assigned_to" value="${pm?.assigned_to || ''}"></div><div class="field"><label>Next Due</label><input type="date" name="next_due" value="${pm?.next_due || today()}" required></div></div>
      <div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  `);
}
function editPM(id) { openPMModal(state.pmSchedules.find(p => p.id === id)); }
function savePM(e) {
  e.preventDefault(); const f = e.target;
  const data = { title: f.title.value, category: f.category.value, frequency: f.frequency.value, asset_id: f.asset_id.value ? parseInt(f.asset_id.value) : null, location_id: f.location_id.value ? parseInt(f.location_id.value) : null, assigned_to: f.assigned_to.value, next_due: f.next_due.value };
  if (state.editing) { Object.assign(state.editing, data); }
  else { data.id = Date.now(); data.last_completed = null; state.pmSchedules.push(data); }
  saveData(); closeModal(); render(); toast('PM schedule saved');
}

function completePM(id) {
  const pm = state.pmSchedules.find(p => p.id === id);
  if (!pm) return;
  pm.last_completed = today();
  const d = new Date();
  if (pm.frequency === 'daily') d.setDate(d.getDate() + 1);
  else if (pm.frequency === 'weekly') d.setDate(d.getDate() + 7);
  else if (pm.frequency === 'monthly') d.setMonth(d.getMonth() + 1);
  else if (pm.frequency === 'quarterly') d.setMonth(d.getMonth() + 3);
  else if (pm.frequency === 'yearly') d.setFullYear(d.getFullYear() + 1);
  pm.next_due = d.toISOString().split('T')[0];
  // Create completed WO
  state.workOrders.unshift({ id: 1000 + state.workOrders.length + 1, title: `PM: ${pm.title}`, location_id: pm.location_id, asset_id: pm.asset_id, category: pm.category, priority: 'medium', status: 'completed', assigned_to: pm.assigned_to, completed_at: today(), labor_hours: 0, labor_cost: 0, parts_cost: 0, total_cost: 0 });
  saveData(); render(); toast('PM completed');
}

function toast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); }

init();
</script>
</body>
</html>
